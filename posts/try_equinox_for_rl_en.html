<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>RLog2 - Try reinforcement learning with equinox</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script type="application/json" class="js-hypothesis-config">
{
  "theme": "clean"
}
</script>
<script async="" src="https://hypothes.is/embed.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">RLog2</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html" rel="" target="">
 <span class="menu-text">RLog2: RL blog 2</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://sigmoid.social/@kngwyu" rel="" target=""><i class="bi bi-mastodon" role="img">
</i> 
 <span class="menu-text">Mastodon</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/kngwyu" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text">Github</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Try reinforcement learning with equinox</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">ja</div>
                <div class="quarto-category">RL</div>
                <div class="quarto-category">deep</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Invalid Date</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-jax-can-do-for-you-and-what-it-doesnt-provide" id="toc-what-jax-can-do-for-you-and-what-it-doesnt-provide" class="nav-link active" data-scroll-target="#what-jax-can-do-for-you-and-what-it-doesnt-provide">What jax can do for you, and what it doesn’t provide</a>
  <ul class="collapse">
  <li><a href="#nn-parameter-management-by-init-apply-approach" id="toc-nn-parameter-management-by-init-apply-approach" class="nav-link" data-scroll-target="#nn-parameter-management-by-init-apply-approach">NN parameter management by init-apply approach</a></li>
  </ul></li>
  <li><a href="#equinox-features" id="toc-equinox-features" class="nav-link" data-scroll-target="#equinox-features">equinox Features</a>
  <ul class="collapse">
  <li><a href="#try-reinforcement-learning" id="toc-try-reinforcement-learning" class="nav-link" data-scroll-target="#try-reinforcement-learning">Try reinforcement learning</a></li>
  <li><a href="#environment" id="toc-environment" class="nav-link" data-scroll-target="#environment">Environment</a></li>
  <li><a href="#lets-implement-ppo." id="toc-lets-implement-ppo." class="nav-link" data-scroll-target="#lets-implement-ppo.">Let’s implement PPO.</a>
  <ul class="collapse">
  <li><a href="#input" id="toc-input" class="nav-link" data-scroll-target="#input">Input</a></li>
  <li><a href="#network" id="toc-network" class="nav-link" data-scroll-target="#network">Network</a></li>
  <li><a href="#rollout" id="toc-rollout" class="nav-link" data-scroll-target="#rollout">Rollout</a></li>
  <li><a href="#learning" id="toc-learning" class="nav-link" data-scroll-target="#learning">Learning</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>I recently tried <a href="https://docs.kidger.site/equinox/">equinox</a>, a <a href="https://jax.readthedocs.io/en/latest/">jax</a>-based library for defining and managing neural nets, and I liked it. So in this blog post I will introduce equinox and demonstrate its use with a reinforcement learning example. Other jax-based NN libraries include <a href="https://dm-haiku.readthedocs.io/en/latest/">haiku</a> from Deepmind and <a href="https://flax.readthedocs.io/en/latest/">flax</a> from Google Research. Both are actually quite similar because their designs are based on <a href="https://jax.readthedocs.io/en/latest/jax.example_libraries.stax.html">stax</a>, which is a reference implementation by the Jax developers. In other words, I would say that both haiku and flax are libraries that have added a PyTorch-like <code>Module</code> to stax. An <a href="https://docs.kidger.site/equinox/examples/init_apply/">equinox document</a> briefly summarizes the approach of haiku and flax, calling it the ‘init-apply approach’. Let’s start this blog post by paraphrasing that document.</p>
<section id="what-jax-can-do-for-you-and-what-it-doesnt-provide" class="level1">
<h1>What jax can do for you, and what it doesn’t provide</h1>
<p>So, what can jax do? Its webpage says that:</p>
<blockquote class="blockquote">
<p>JAX is Autograd and XLA, brought together for high-performance numerical computing.</p>
</blockquote>
<p><a href="https://www.tensorflow.org/xla">XLA</a> is an intermediate language for deep learning developed as a backend to Tensorflow. It’s intended for producing optimized programs for vector accelartors like GPU, TPU, and even modern CPU’s SIMD instructions. Jax provides a NumPy-like library called <code>jax.numpy</code> as a front-end to XLA, which allows NumPy-like Python code to be vector-parallelized into fast GPU code by runtime (just-in-time) compilation. So what is Autograd? This is also the name of a library previously developed by the developers of jax, but you can think of it as autodifferentiation in general. Autodifferentiation is a technique to automatically derive gradients of functions in numerical computation. Jax supports autograd, which means that you can derive the partial derivative of the function w.r.t. your inputs, without explicitly write the code to do that. Let’s try to compute the partial derivative of <span class="math inline">\(f(x, y) = x^2 + y\)</span>:</p>
<div class="cell" data-tags="[]" data-execution_count="2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.numpy <span class="im">as</span> jnp</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f(x: jax.Array, y: jax.Array) <span class="op">-&gt;</span> jax.Array:</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jnp.<span class="bu">sum</span>(x <span class="op">**</span> <span class="dv">2</span> <span class="op">+</span> y)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> jnp.array([<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>], dtype<span class="op">=</span>jnp.float32)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> jnp.array([<span class="dv">5</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">2</span>], dtype<span class="op">=</span>jnp.float32)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>jax.grad(f, argnums<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))(x, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>(Array([ 6.,  8., 10., 12., 14.], dtype=float32),
 Array([1., 1., 1., 1., 1.], dtype=float32))</code></pre>
</div>
</div>
<p>Since <span class="math inline">\(\frac{\partial}{\partial x}f = 2x, \frac{\partial}{\partial y}f = 1\)</span>, the outputs look correct. Since jax automatically computes partial derivatives, you can use it directly for gradient descent to train your NN model. In addition, if you put the computation of taking this gradient and updating the model into <code>jax.jit</code>, it can acceralate the whole model traning procedure. The problem here is that there are too many parameters in the case of deep neural networks, so it would be too much work to write a program like this, assigning variables for every single parameter. This is a surprisingly serious problem because recent deep NN often have too many parameters, difficult to manage by hand. So I want a system to efficiently manage the all parameters of my model with covenient abstractions.</p>
<section id="nn-parameter-management-by-init-apply-approach" class="level2">
<h2 class="anchored" data-anchor-id="nn-parameter-management-by-init-apply-approach">NN parameter management by init-apply approach</h2>
<p>In stax, haiku, and flax, this problem of parameter management is solved by the so-called “init-apply approach”, which can be summarized as:</p>
<ol type="1">
<li>the <em>model</em> has no parameters</li>
<li>instead, the <em>model</em> is just a set of two functions: <code>init</code> and <code>apply</code></li>
</ol>
<ul>
<li><code>init</code> takes an example input, initializes the parameters, and returns the initial parameter</li>
<li><code>apply</code> takes input and parameters, and then compute the output of the model</li>
</ul>
<p>So the APIs for flax and haiku are as follows. While there are a number of differences (e.g., flax uses <code>__call__</code> (while haiku uses <code>forward</code> like PyTorch (just like how Chainer and PyTorch differ), <code>flax</code> employs <a href="https://%20docs.python.org/en/3/library/dataclasses.html#dataclasses.dataclass"><code>dataclasses.dataclass</code></a> for Module class), their design is quite similar.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Linear(Module):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, x):</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>        batch_size <span class="op">=</span> x.shape[<span class="dv">0</span>]</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> <span class="va">self</span>.parameter(output, shape<span class="op">=</span>(batch_size, <span class="va">self</span>.output_size) init<span class="op">=</span><span class="va">self</span>.w_init)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        b <span class="op">=</span> <span class="va">self</span>.parameter(output, shape<span class="op">=</span>(<span class="dv">1</span>, <span class="va">self</span>.output_size) init<span class="op">=</span><span class="va">self</span>.w_init)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> w <span class="op">@</span> x.T <span class="op">+</span> b</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Linear(output_size<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> model.init(jnp.zeros(<span class="dv">1</span>, <span class="dv">100</span>))</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> model.<span class="bu">apply</span>(params, jnp.zeros(<span class="dv">10</span>, <span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In the above example, I used <code>Module</code> to represent the abstract class for defining NN. Note that he method <code>self.parameter</code> in the above example is the counterpart of the parameter registration functions in <code>flax</code> and <code>haiku</code>. In the case of <code>haiku</code>, the <code>params</code> is the following <code>dict</code>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Linear/~/w"</span>: [...],</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Linear/~/b"</span>: [...],</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>So, it means that users need to know this naming scheme to access a specific value of parameter. <code>stax</code> doesn’t have <code>Module</code> feature. Instead, it provides function combinator to combine multiple <code>init</code> and <code>apply</code>. Then let’s summarize the pros and cons of this approach.</p>
<p><strong>Pros</strong></p>
<ul>
<li>No need to specify the shape of the input Array when initializing the Module
<ul>
<li>Parameters are initialized when <code>init</code> is called</li>
</ul></li>
<li>Functions and data are separated
<ul>
<li>Module has no variables that can be changed, and is treated completely separately from its parameters</li>
</ul></li>
</ul>
<p><strong>Disadvantages</strong>.</p>
<ul>
<li>(Only haiku/flax) Module is redundant
<ul>
<li>Module only has “model settings” such as output dimensions</li>
</ul></li>
<li>Direct access to parameter elements is cumbersome
<ul>
<li>For example, in haiku, each parameter element can be accessed with <code>params["Linear/~/w"]</code>, so we need to understand this naming scheme for keys to check parameters</li>
</ul></li>
<li>Not very object oriented
<ul>
<li>Because classes don’t have data</li>
</ul></li>
<li>(Only haiku/flax) Parameter calls in Module need to be converted to functions that can be used by <code>jax.grad</code>.
<ul>
<li>For example, <code>haiku.transform</code> converts functions that include parameter calls with <code>haiku.get_parameter</code> into functions that take parameters as arguments</li>
</ul></li>
</ul>
</section>
</section>
<section id="equinox-features" class="level1">
<h1>equinox Features</h1>
<p>Equinox is geared toward “more object-oriented” (or PyTorch-like) interface, compared to the init-apply approach. Take a look at <a href="https://docs.kidger.site/equinox/#quick-example">Quick example</a> on the top page of the documentation.</p>
<div class="cell" data-tags="[]" data-execution_count="3">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> equinox <span class="im">as</span> eqx</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Linear(eqx.Module):</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    weight: jax.Array</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    bias: jax.Array</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, in_size, out_size, key):</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        wkey, bkey <span class="op">=</span> jax.random.split(key)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.weight <span class="op">=</span> jax.random.normal(wkey, (out_size, in_size))</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.bias <span class="op">=</span> jax.random.normal(bkey, (out_size,))</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, x):</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.weight <span class="op">@</span> x <span class="op">+</span> <span class="va">self</span>.bias</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.grad</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> loss_fn(model, x, y):</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    pred_y <span class="op">=</span> jax.vmap(model)(x)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jax.numpy.mean((y <span class="op">-</span> pred_y) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>batch_size, in_size, out_size <span class="op">=</span> <span class="dv">32</span>, <span class="dv">2</span>, <span class="dv">3</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Linear(in_size, out_size, key<span class="op">=</span>jax.random.PRNGKey(<span class="dv">0</span>))</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> jax.numpy.zeros((batch_size, in_size))</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> jax.numpy.zeros((batch_size, out_size))</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>grads <span class="op">=</span> loss_fn(model, x, y)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Model weight?"</span>, model.weight)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Grad?"</span>, grads)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model weight? [[0.59902626 0.2172144 ]
 [0.660603   0.03266738]
 [1.2164948  1.1940813 ]]
Grad? Linear(weight=f32[3,2], bias=f32[3])</code></pre>
</div>
</div>
<p>Here, the most significant feature of equinox is that the Module directly has parameters, as show in:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Linear(eqx.Module):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    weight: jax.Array</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    bias: jax.Array</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Compared to the init-apply approach, what pros and cons does this approach have?</p>
<p><strong>Pros</strong></p>
<ul>
<li>Easy to understand</li>
<li>Easy to debug
<ul>
<li>In flax and haiku, we need to <code>transform</code> the module for debugging</li>
<li>We can write test codes in a few lines, like <code>net = Module(...); net(input)</code></li>
</ul></li>
<li>Easy to manually manipulate parameters</li>
</ul>
<p><strong>Cons</strong></p>
<ul>
<li>Modules require input dimensions when initialization</li>
<li>Modules need to be separtated into NN parameters and other constants before applying<code>grad</code>, <code>jit</code>, and <code>scan</code> or some other jax decorators</li>
</ul>
<p>What does the last sentence <code>Modules need to be separtated into NN parameters and other constants</code> mean? Let’s consider Self-Attention example below:</p>
<div class="cell" data-tags="[]" data-execution_count="17">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SelfAttention(eqx.Module):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    q: eqx.nn.Linear</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    k: eqx.nn.Linear</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    v: eqx.nn.Linear</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    sqrt_d_attn: <span class="bu">float</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, d_in: <span class="bu">int</span>, d_attn: <span class="bu">int</span>, key: jax.Array) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        q_key, k_key, v_key <span class="op">=</span> jax.random.split(key, <span class="dv">3</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.q <span class="op">=</span> eqx.nn.Linear(d_in, d_attn, key<span class="op">=</span>q_key)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.k <span class="op">=</span> eqx.nn.Linear(d_in, d_attn, key<span class="op">=</span>k_key)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.v <span class="op">=</span> eqx.nn.Linear(d_in, d_attn, key<span class="op">=</span>v_key)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sqrt_d_attn <span class="op">=</span> <span class="bu">float</span>(jnp.sqrt(d_attn))</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, e: jax.Array) <span class="op">-&gt;</span> jax.Array:</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        q <span class="op">=</span> jax.vmap(<span class="va">self</span>.q)(e)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> jax.vmap(<span class="va">self</span>.k)(e)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        alpha <span class="op">=</span> jax.nn.softmax(q.T <span class="op">@</span> k <span class="op">/</span> <span class="va">self</span>.sqrt_d_attn, axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> jax.vmap(<span class="va">self</span>.v)(e) <span class="op">@</span> alpha.T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>While initialization methods such as <code>__init__</code> are prepared in advance since <code>eqx.Module</code> uses <code>dataclasses.dataclass</code> internally, but let’s override them to initialize parameters. Since <span class="math inline">\(\sqrt{d_\mathrm{attn}}\)</span> is a constant, let’s make it a member variable as well. Let’s compute gradients:</p>
<div class="cell" data-tags="[]" data-execution_count="18">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> SelfAttention(<span class="dv">4</span>, <span class="dv">8</span>, jax.random.PRNGKey(<span class="dv">10</span>))</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>jax.grad(<span class="kw">lambda</span> model, x: jnp.mean(model(x)))(model, jnp.ones((<span class="dv">3</span>, <span class="dv">4</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>SelfAttention(
  q=Linear(
    weight=f32[8,4],
    bias=f32[8],
    in_features=4,
    out_features=8,
    use_bias=True
  ),
  k=Linear(
    weight=f32[8,4],
    bias=f32[8],
    in_features=4,
    out_features=8,
    use_bias=True
  ),
  v=Linear(
    weight=f32[8,4],
    bias=f32[8],
    in_features=4,
    out_features=8,
    use_bias=True
  ),
  sqrt_d_attn=f32[]
)</code></pre>
</div>
</div>
<p>The trouble here is that the partial derivative in <code>sqrt_d_attn</code> is also computed. The fact that <code>eqx.Module</code> itself has a parameter causes partial derivatives to be computed even for member variables that would otherwise be constants. This problem is solved in equinox by using <a href="https://docs.kidger.site/equinox/api/filtering/partition-combine/#equinox.partition"><code>eqx.partition</code></a> and <a href="https://docs.kidger.site/equinox/api/filtering/partition-combine/#equinox.is_inexact_array"><code>eqx.is_inexact_array</code></a> to separate a module instance to a “32-bit floating-point <code>jax. Array</code> or <code>numpy.ndarray</code>” and “other member variables”. Let’s try it.</p>
<div class="cell" data-tags="[]" data-execution_count="19">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>eqx.partition(model, eqx.is_inexact_array)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>(SelfAttention(
   q=Linear(
     weight=f32[8,4],
     bias=f32[8],
     in_features=4,
     out_features=8,
     use_bias=True
   ),
   k=Linear(
     weight=f32[8,4],
     bias=f32[8],
     in_features=4,
     out_features=8,
     use_bias=True
   ),
   v=Linear(
     weight=f32[8,4],
     bias=f32[8],
     in_features=4,
     out_features=8,
     use_bias=True
   ),
   sqrt_d_attn=None
 ),
 SelfAttention(
   q=Linear(weight=None, bias=None, in_features=4, out_features=8, use_bias=True),
   k=Linear(weight=None, bias=None, in_features=4, out_features=8, use_bias=True),
   v=Linear(weight=None, bias=None, in_features=4, out_features=8, use_bias=True),
   sqrt_d_attn=2.8284270763397217
 ))</code></pre>
</div>
</div>
<p>We can see the struct is divided into one with <code>sqrt_d_attn=None</code> and one with<code>sqrt_d_attn=2.8284270763397217</code>. To summarize, when we want to compute the gradients of w.r.t. all parameters in the module with non-parameter member variables,</p>
<ol type="1">
<li>Split Module into parameters and others.</li>
<li>Creaate a function <code>f(module, ...)</code> of which you want the gradient.</li>
<li>Create a function that wraps <code>f</code> with separated arguments for paremters and non-parameters. Say, <code>wrapped_f(params, others, ...)</code></li>
<li>compute the gradient with <code>jax.grad(wrapped_f)(params, others, ...)</code></li>
</ol>
<p>It’s tiring. But a good news is that <a href="https://docs.kidger.site/equinox/api/filtering/transformations/#equinox.filter_%20grad"><code>equinox.filter_grad</code></a> can do all of this tiring procedure for us. You can use it for most cases. Let’s try it.</p>
<div class="cell" data-tags="[]" data-execution_count="20">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>eqx.filter_grad(<span class="kw">lambda</span> model, x: jnp.mean(model(x)))(model, jnp.ones((<span class="dv">3</span>, <span class="dv">4</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>SelfAttention(
  q=Linear(
    weight=f32[8,4],
    bias=f32[8],
    in_features=4,
    out_features=8,
    use_bias=True
  ),
  k=Linear(
    weight=f32[8,4],
    bias=f32[8],
    in_features=4,
    out_features=8,
    use_bias=True
  ),
  v=Linear(
    weight=f32[8,4],
    bias=f32[8],
    in_features=4,
    out_features=8,
    use_bias=True
  ),
  sqrt_d_attn=None
)</code></pre>
</div>
</div>
<p>It returned the gradient correctly. The constant <code>sqrt_d_attn</code> is exactly masked by <code>None</code>. So, if you want to have a constant in a Module, just use a type other than <code>jax.Array</code> or <code>ndarray</code> for now. If you want to have a constant as <code>jax.Array</code>, you can’t <code>filter_value_and_grad</code> directly and you need to manually decompose the struct. So I recommend to just have constants as Python built-in types such as <code>float</code>. If you use <code>jax.jit</code>, they are just compiled to a part of binary code, so it adds no overhead.</p>
<section id="try-reinforcement-learning" class="level2">
<h2 class="anchored" data-anchor-id="try-reinforcement-learning">Try reinforcement learning</h2>
</section>
<section id="environment" class="level2">
<h2 class="anchored" data-anchor-id="environment">Environment</h2>
<p>Now that we have introduced the features of <code>equinox</code>, let’s try reinforcement learning with it. Since we are using jax <del>and since the API of Gym has changed a lot and changed to gymnasium we can’t keep up with it at all</del>, let’s use an environment made by jax. Here I use <a href="https://instadeepai.github.io/jumanji/environments/maze/">Maze</a> from the <a href="https://instadeepai.github.io/jumanji/">jumanji</a>.</p>
<div class="cell" data-tags="[]" data-execution_count="21">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jumanji</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jumanji.wrappers <span class="im">import</span> AutoResetWrapper</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> HTML</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>env <span class="op">=</span> jumanji.make(<span class="st">"Maze-v0"</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>env <span class="op">=</span> AutoResetWrapper(env)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>n_actions <span class="op">=</span> env.action_spec().num_values</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>key, <span class="op">*</span>keys <span class="op">=</span> jax.random.split(jax.random.PRNGKey(<span class="dv">20230720</span>), <span class="dv">11</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>state, timestep <span class="op">=</span> env.reset(key)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>states <span class="op">=</span> [state]</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key <span class="kw">in</span> keys:</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    action <span class="op">=</span> jax.random.randint(key<span class="op">=</span>key, minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span>n_actions, shape<span class="op">=</span>())</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    state, timestep <span class="op">=</span> env.step(state, action)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    states.append(state)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>anim <span class="op">=</span> env.animate(states)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>HTML(anim.to_html5_video().replace(<span class="st">'="1000"'</span>, <span class="st">'="640"'</span>))  <span class="co"># Change video size</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/javascript">
/* Put everything inside the global mpl namespace */
/* global mpl */
window.mpl = {};

mpl.get_websocket_type = function () {
    if (typeof WebSocket !== 'undefined') {
        return WebSocket;
    } else if (typeof MozWebSocket !== 'undefined') {
        return MozWebSocket;
    } else {
        alert(
            'Your browser does not have WebSocket support. ' +
                'Please try Chrome, Safari or Firefox ≥ 6. ' +
                'Firefox 4 and 5 are also supported but you ' +
                'have to enable WebSockets in about:config.'
        );
    }
};

mpl.figure = function (figure_id, websocket, ondownload, parent_element) {
    this.id = figure_id;

    this.ws = websocket;

    this.supports_binary = this.ws.binaryType !== undefined;

    if (!this.supports_binary) {
        var warnings = document.getElementById('mpl-warnings');
        if (warnings) {
            warnings.style.display = 'block';
            warnings.textContent =
                'This browser does not support binary websocket messages. ' +
                'Performance may be slow.';
        }
    }

    this.imageObj = new Image();

    this.context = undefined;
    this.message = undefined;
    this.canvas = undefined;
    this.rubberband_canvas = undefined;
    this.rubberband_context = undefined;
    this.format_dropdown = undefined;

    this.image_mode = 'full';

    this.root = document.createElement('div');
    this.root.setAttribute('style', 'display: inline-block');
    this._root_extra_style(this.root);

    parent_element.appendChild(this.root);

    this._init_header(this);
    this._init_canvas(this);
    this._init_toolbar(this);

    var fig = this;

    this.waiting = false;

    this.ws.onopen = function () {
        fig.send_message('supports_binary', { value: fig.supports_binary });
        fig.send_message('send_image_mode', {});
        if (fig.ratio !== 1) {
            fig.send_message('set_device_pixel_ratio', {
                device_pixel_ratio: fig.ratio,
            });
        }
        fig.send_message('refresh', {});
    };

    this.imageObj.onload = function () {
        if (fig.image_mode === 'full') {
            // Full images could contain transparency (where diff images
            // almost always do), so we need to clear the canvas so that
            // there is no ghosting.
            fig.context.clearRect(0, 0, fig.canvas.width, fig.canvas.height);
        }
        fig.context.drawImage(fig.imageObj, 0, 0);
    };

    this.imageObj.onunload = function () {
        fig.ws.close();
    };

    this.ws.onmessage = this._make_on_message_function(this);

    this.ondownload = ondownload;
};

mpl.figure.prototype._init_header = function () {
    var titlebar = document.createElement('div');
    titlebar.classList =
        'ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix';
    var titletext = document.createElement('div');
    titletext.classList = 'ui-dialog-title';
    titletext.setAttribute(
        'style',
        'width: 100%; text-align: center; padding: 3px;'
    );
    titlebar.appendChild(titletext);
    this.root.appendChild(titlebar);
    this.header = titletext;
};

mpl.figure.prototype._canvas_extra_style = function (_canvas_div) {};

mpl.figure.prototype._root_extra_style = function (_canvas_div) {};

mpl.figure.prototype._init_canvas = function () {
    var fig = this;

    var canvas_div = (this.canvas_div = document.createElement('div'));
    canvas_div.setAttribute('tabindex', '0');
    canvas_div.setAttribute(
        'style',
        'border: 1px solid #ddd;' +
            'box-sizing: content-box;' +
            'clear: both;' +
            'min-height: 1px;' +
            'min-width: 1px;' +
            'outline: 0;' +
            'overflow: hidden;' +
            'position: relative;' +
            'resize: both;' +
            'z-index: 2;'
    );

    function on_keyboard_event_closure(name) {
        return function (event) {
            return fig.key_event(event, name);
        };
    }

    canvas_div.addEventListener(
        'keydown',
        on_keyboard_event_closure('key_press')
    );
    canvas_div.addEventListener(
        'keyup',
        on_keyboard_event_closure('key_release')
    );

    this._canvas_extra_style(canvas_div);
    this.root.appendChild(canvas_div);

    var canvas = (this.canvas = document.createElement('canvas'));
    canvas.classList.add('mpl-canvas');
    canvas.setAttribute(
        'style',
        'box-sizing: content-box;' +
            'pointer-events: none;' +
            'position: relative;' +
            'z-index: 0;'
    );

    this.context = canvas.getContext('2d');

    var backingStore =
        this.context.backingStorePixelRatio ||
        this.context.webkitBackingStorePixelRatio ||
        this.context.mozBackingStorePixelRatio ||
        this.context.msBackingStorePixelRatio ||
        this.context.oBackingStorePixelRatio ||
        this.context.backingStorePixelRatio ||
        1;

    this.ratio = (window.devicePixelRatio || 1) / backingStore;

    var rubberband_canvas = (this.rubberband_canvas = document.createElement(
        'canvas'
    ));
    rubberband_canvas.setAttribute(
        'style',
        'box-sizing: content-box;' +
            'left: 0;' +
            'pointer-events: none;' +
            'position: absolute;' +
            'top: 0;' +
            'z-index: 1;'
    );

    // Apply a ponyfill if ResizeObserver is not implemented by browser.
    if (this.ResizeObserver === undefined) {
        if (window.ResizeObserver !== undefined) {
            this.ResizeObserver = window.ResizeObserver;
        } else {
            var obs = _JSXTOOLS_RESIZE_OBSERVER({});
            this.ResizeObserver = obs.ResizeObserver;
        }
    }

    this.resizeObserverInstance = new this.ResizeObserver(function (entries) {
        var nentries = entries.length;
        for (var i = 0; i < nentries; i++) {
            var entry = entries[i];
            var width, height;
            if (entry.contentBoxSize) {
                if (entry.contentBoxSize instanceof Array) {
                    // Chrome 84 implements new version of spec.
                    width = entry.contentBoxSize[0].inlineSize;
                    height = entry.contentBoxSize[0].blockSize;
                } else {
                    // Firefox implements old version of spec.
                    width = entry.contentBoxSize.inlineSize;
                    height = entry.contentBoxSize.blockSize;
                }
            } else {
                // Chrome <84 implements even older version of spec.
                width = entry.contentRect.width;
                height = entry.contentRect.height;
            }

            // Keep the size of the canvas and rubber band canvas in sync with
            // the canvas container.
            if (entry.devicePixelContentBoxSize) {
                // Chrome 84 implements new version of spec.
                canvas.setAttribute(
                    'width',
                    entry.devicePixelContentBoxSize[0].inlineSize
                );
                canvas.setAttribute(
                    'height',
                    entry.devicePixelContentBoxSize[0].blockSize
                );
            } else {
                canvas.setAttribute('width', width * fig.ratio);
                canvas.setAttribute('height', height * fig.ratio);
            }
            /* This rescales the canvas back to display pixels, so that it
             * appears correct on HiDPI screens. */
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';

            rubberband_canvas.setAttribute('width', width);
            rubberband_canvas.setAttribute('height', height);

            // And update the size in Python. We ignore the initial 0/0 size
            // that occurs as the element is placed into the DOM, which should
            // otherwise not happen due to the minimum size styling.
            if (fig.ws.readyState == 1 && width != 0 && height != 0) {
                fig.request_resize(width, height);
            }
        }
    });
    this.resizeObserverInstance.observe(canvas_div);

    function on_mouse_event_closure(name) {
        /* User Agent sniffing is bad, but WebKit is busted:
         * https://bugs.webkit.org/show_bug.cgi?id=144526
         * https://bugs.webkit.org/show_bug.cgi?id=181818
         * The worst that happens here is that they get an extra browser
         * selection when dragging, if this check fails to catch them.
         */
        var UA = navigator.userAgent;
        var isWebKit = /AppleWebKit/.test(UA) && !/Chrome/.test(UA);
        if(isWebKit) {
            return function (event) {
                /* This prevents the web browser from automatically changing to
                 * the text insertion cursor when the button is pressed. We
                 * want to control all of the cursor setting manually through
                 * the 'cursor' event from matplotlib */
                event.preventDefault()
                return fig.mouse_event(event, name);
            };
        } else {
            return function (event) {
                return fig.mouse_event(event, name);
            };
        }
    }

    canvas_div.addEventListener(
        'mousedown',
        on_mouse_event_closure('button_press')
    );
    canvas_div.addEventListener(
        'mouseup',
        on_mouse_event_closure('button_release')
    );
    canvas_div.addEventListener(
        'dblclick',
        on_mouse_event_closure('dblclick')
    );
    // Throttle sequential mouse events to 1 every 20ms.
    canvas_div.addEventListener(
        'mousemove',
        on_mouse_event_closure('motion_notify')
    );

    canvas_div.addEventListener(
        'mouseenter',
        on_mouse_event_closure('figure_enter')
    );
    canvas_div.addEventListener(
        'mouseleave',
        on_mouse_event_closure('figure_leave')
    );

    canvas_div.addEventListener('wheel', function (event) {
        if (event.deltaY < 0) {
            event.step = 1;
        } else {
            event.step = -1;
        }
        on_mouse_event_closure('scroll')(event);
    });

    canvas_div.appendChild(canvas);
    canvas_div.appendChild(rubberband_canvas);

    this.rubberband_context = rubberband_canvas.getContext('2d');
    this.rubberband_context.strokeStyle = '#000000';

    this._resize_canvas = function (width, height, forward) {
        if (forward) {
            canvas_div.style.width = width + 'px';
            canvas_div.style.height = height + 'px';
        }
    };

    // Disable right mouse context menu.
    canvas_div.addEventListener('contextmenu', function (_e) {
        event.preventDefault();
        return false;
    });

    function set_focus() {
        canvas.focus();
        canvas_div.focus();
    }

    window.setTimeout(set_focus, 100);
};

mpl.figure.prototype._init_toolbar = function () {
    var fig = this;

    var toolbar = document.createElement('div');
    toolbar.classList = 'mpl-toolbar';
    this.root.appendChild(toolbar);

    function on_click_closure(name) {
        return function (_event) {
            return fig.toolbar_button_onclick(name);
        };
    }

    function on_mouseover_closure(tooltip) {
        return function (event) {
            if (!event.currentTarget.disabled) {
                return fig.toolbar_button_onmouseover(tooltip);
            }
        };
    }

    fig.buttons = {};
    var buttonGroup = document.createElement('div');
    buttonGroup.classList = 'mpl-button-group';
    for (var toolbar_ind in mpl.toolbar_items) {
        var name = mpl.toolbar_items[toolbar_ind][0];
        var tooltip = mpl.toolbar_items[toolbar_ind][1];
        var image = mpl.toolbar_items[toolbar_ind][2];
        var method_name = mpl.toolbar_items[toolbar_ind][3];

        if (!name) {
            /* Instead of a spacer, we start a new button group. */
            if (buttonGroup.hasChildNodes()) {
                toolbar.appendChild(buttonGroup);
            }
            buttonGroup = document.createElement('div');
            buttonGroup.classList = 'mpl-button-group';
            continue;
        }

        var button = (fig.buttons[name] = document.createElement('button'));
        button.classList = 'mpl-widget';
        button.setAttribute('role', 'button');
        button.setAttribute('aria-disabled', 'false');
        button.addEventListener('click', on_click_closure(method_name));
        button.addEventListener('mouseover', on_mouseover_closure(tooltip));

        var icon_img = document.createElement('img');
        icon_img.src = '_images/' + image + '.png';
        icon_img.srcset = '_images/' + image + '_large.png 2x';
        icon_img.alt = tooltip;
        button.appendChild(icon_img);

        buttonGroup.appendChild(button);
    }

    if (buttonGroup.hasChildNodes()) {
        toolbar.appendChild(buttonGroup);
    }

    var fmt_picker = document.createElement('select');
    fmt_picker.classList = 'mpl-widget';
    toolbar.appendChild(fmt_picker);
    this.format_dropdown = fmt_picker;

    for (var ind in mpl.extensions) {
        var fmt = mpl.extensions[ind];
        var option = document.createElement('option');
        option.selected = fmt === mpl.default_extension;
        option.innerHTML = fmt;
        fmt_picker.appendChild(option);
    }

    var status_bar = document.createElement('span');
    status_bar.classList = 'mpl-message';
    toolbar.appendChild(status_bar);
    this.message = status_bar;
};

mpl.figure.prototype.request_resize = function (x_pixels, y_pixels) {
    // Request matplotlib to resize the figure. Matplotlib will then trigger a resize in the client,
    // which will in turn request a refresh of the image.
    this.send_message('resize', { width: x_pixels, height: y_pixels });
};

mpl.figure.prototype.send_message = function (type, properties) {
    properties['type'] = type;
    properties['figure_id'] = this.id;
    this.ws.send(JSON.stringify(properties));
};

mpl.figure.prototype.send_draw_message = function () {
    if (!this.waiting) {
        this.waiting = true;
        this.ws.send(JSON.stringify({ type: 'draw', figure_id: this.id }));
    }
};

mpl.figure.prototype.handle_save = function (fig, _msg) {
    var format_dropdown = fig.format_dropdown;
    var format = format_dropdown.options[format_dropdown.selectedIndex].value;
    fig.ondownload(fig, format);
};

mpl.figure.prototype.handle_resize = function (fig, msg) {
    var size = msg['size'];
    if (size[0] !== fig.canvas.width || size[1] !== fig.canvas.height) {
        fig._resize_canvas(size[0], size[1], msg['forward']);
        fig.send_message('refresh', {});
    }
};

mpl.figure.prototype.handle_rubberband = function (fig, msg) {
    var x0 = msg['x0'] / fig.ratio;
    var y0 = (fig.canvas.height - msg['y0']) / fig.ratio;
    var x1 = msg['x1'] / fig.ratio;
    var y1 = (fig.canvas.height - msg['y1']) / fig.ratio;
    x0 = Math.floor(x0) + 0.5;
    y0 = Math.floor(y0) + 0.5;
    x1 = Math.floor(x1) + 0.5;
    y1 = Math.floor(y1) + 0.5;
    var min_x = Math.min(x0, x1);
    var min_y = Math.min(y0, y1);
    var width = Math.abs(x1 - x0);
    var height = Math.abs(y1 - y0);

    fig.rubberband_context.clearRect(
        0,
        0,
        fig.canvas.width / fig.ratio,
        fig.canvas.height / fig.ratio
    );

    fig.rubberband_context.strokeRect(min_x, min_y, width, height);
};

mpl.figure.prototype.handle_figure_label = function (fig, msg) {
    // Updates the figure title.
    fig.header.textContent = msg['label'];
};

mpl.figure.prototype.handle_cursor = function (fig, msg) {
    fig.canvas_div.style.cursor = msg['cursor'];
};

mpl.figure.prototype.handle_message = function (fig, msg) {
    fig.message.textContent = msg['message'];
};

mpl.figure.prototype.handle_draw = function (fig, _msg) {
    // Request the server to send over a new figure.
    fig.send_draw_message();
};

mpl.figure.prototype.handle_image_mode = function (fig, msg) {
    fig.image_mode = msg['mode'];
};

mpl.figure.prototype.handle_history_buttons = function (fig, msg) {
    for (var key in msg) {
        if (!(key in fig.buttons)) {
            continue;
        }
        fig.buttons[key].disabled = !msg[key];
        fig.buttons[key].setAttribute('aria-disabled', !msg[key]);
    }
};

mpl.figure.prototype.handle_navigate_mode = function (fig, msg) {
    if (msg['mode'] === 'PAN') {
        fig.buttons['Pan'].classList.add('active');
        fig.buttons['Zoom'].classList.remove('active');
    } else if (msg['mode'] === 'ZOOM') {
        fig.buttons['Pan'].classList.remove('active');
        fig.buttons['Zoom'].classList.add('active');
    } else {
        fig.buttons['Pan'].classList.remove('active');
        fig.buttons['Zoom'].classList.remove('active');
    }
};

mpl.figure.prototype.updated_canvas_event = function () {
    // Called whenever the canvas gets updated.
    this.send_message('ack', {});
};

// A function to construct a web socket function for onmessage handling.
// Called in the figure constructor.
mpl.figure.prototype._make_on_message_function = function (fig) {
    return function socket_on_message(evt) {
        if (evt.data instanceof Blob) {
            var img = evt.data;
            if (img.type !== 'image/png') {
                /* FIXME: We get "Resource interpreted as Image but
                 * transferred with MIME type text/plain:" errors on
                 * Chrome.  But how to set the MIME type?  It doesn't seem
                 * to be part of the websocket stream */
                img.type = 'image/png';
            }

            /* Free the memory for the previous frames */
            if (fig.imageObj.src) {
                (window.URL || window.webkitURL).revokeObjectURL(
                    fig.imageObj.src
                );
            }

            fig.imageObj.src = (window.URL || window.webkitURL).createObjectURL(
                img
            );
            fig.updated_canvas_event();
            fig.waiting = false;
            return;
        } else if (
            typeof evt.data === 'string' &&
            evt.data.slice(0, 21) === 'data:image/png;base64'
        ) {
            fig.imageObj.src = evt.data;
            fig.updated_canvas_event();
            fig.waiting = false;
            return;
        }

        var msg = JSON.parse(evt.data);
        var msg_type = msg['type'];

        // Call the  "handle_{type}" callback, which takes
        // the figure and JSON message as its only arguments.
        try {
            var callback = fig['handle_' + msg_type];
        } catch (e) {
            console.log(
                "No handler for the '" + msg_type + "' message type: ",
                msg
            );
            return;
        }

        if (callback) {
            try {
                // console.log("Handling '" + msg_type + "' message: ", msg);
                callback(fig, msg);
            } catch (e) {
                console.log(
                    "Exception inside the 'handler_" + msg_type + "' callback:",
                    e,
                    e.stack,
                    msg
                );
            }
        }
    };
};

function getModifiers(event) {
    var mods = [];
    if (event.ctrlKey) {
        mods.push('ctrl');
    }
    if (event.altKey) {
        mods.push('alt');
    }
    if (event.shiftKey) {
        mods.push('shift');
    }
    if (event.metaKey) {
        mods.push('meta');
    }
    return mods;
}

/*
 * return a copy of an object with only non-object keys
 * we need this to avoid circular references
 * https://stackoverflow.com/a/24161582/3208463
 */
function simpleKeys(original) {
    return Object.keys(original).reduce(function (obj, key) {
        if (typeof original[key] !== 'object') {
            obj[key] = original[key];
        }
        return obj;
    }, {});
}

mpl.figure.prototype.mouse_event = function (event, name) {
    if (name === 'button_press') {
        this.canvas.focus();
        this.canvas_div.focus();
    }

    // from https://stackoverflow.com/q/1114465
    var boundingRect = this.canvas.getBoundingClientRect();
    var x = (event.clientX - boundingRect.left) * this.ratio;
    var y = (event.clientY - boundingRect.top) * this.ratio;

    this.send_message(name, {
        x: x,
        y: y,
        button: event.button,
        step: event.step,
        modifiers: getModifiers(event),
        guiEvent: simpleKeys(event),
    });

    return false;
};

mpl.figure.prototype._key_event_extra = function (_event, _name) {
    // Handle any extra behaviour associated with a key event
};

mpl.figure.prototype.key_event = function (event, name) {
    // Prevent repeat events
    if (name === 'key_press') {
        if (event.key === this._key) {
            return;
        } else {
            this._key = event.key;
        }
    }
    if (name === 'key_release') {
        this._key = null;
    }

    var value = '';
    if (event.ctrlKey && event.key !== 'Control') {
        value += 'ctrl+';
    }
    else if (event.altKey && event.key !== 'Alt') {
        value += 'alt+';
    }
    else if (event.shiftKey && event.key !== 'Shift') {
        value += 'shift+';
    }

    value += 'k' + event.key;

    this._key_event_extra(event, name);

    this.send_message(name, { key: value, guiEvent: simpleKeys(event) });
    return false;
};

mpl.figure.prototype.toolbar_button_onclick = function (name) {
    if (name === 'download') {
        this.handle_save(this, null);
    } else {
        this.send_message('toolbar_button', { name: name });
    }
};

mpl.figure.prototype.toolbar_button_onmouseover = function (tooltip) {
    this.message.textContent = tooltip;
};

///////////////// REMAINING CONTENT GENERATED BY embed_js.py /////////////////
// prettier-ignore
var _JSXTOOLS_RESIZE_OBSERVER=function(A){var t,i=new WeakMap,n=new WeakMap,a=new WeakMap,r=new WeakMap,o=new Set;function s(e){if(!(this instanceof s))throw new TypeError("Constructor requires 'new' operator");i.set(this,e)}function h(){throw new TypeError("Function is not a constructor")}function c(e,t,i,n){e=0 in arguments?Number(arguments[0]):0,t=1 in arguments?Number(arguments[1]):0,i=2 in arguments?Number(arguments[2]):0,n=3 in arguments?Number(arguments[3]):0,this.right=(this.x=this.left=e)+(this.width=i),this.bottom=(this.y=this.top=t)+(this.height=n),Object.freeze(this)}function d(){t=requestAnimationFrame(d);var s=new WeakMap,p=new Set;o.forEach((function(t){r.get(t).forEach((function(i){var r=t instanceof window.SVGElement,o=a.get(t),d=r?0:parseFloat(o.paddingTop),f=r?0:parseFloat(o.paddingRight),l=r?0:parseFloat(o.paddingBottom),u=r?0:parseFloat(o.paddingLeft),g=r?0:parseFloat(o.borderTopWidth),m=r?0:parseFloat(o.borderRightWidth),w=r?0:parseFloat(o.borderBottomWidth),b=u+f,F=d+l,v=(r?0:parseFloat(o.borderLeftWidth))+m,W=g+w,y=r?0:t.offsetHeight-W-t.clientHeight,E=r?0:t.offsetWidth-v-t.clientWidth,R=b+v,z=F+W,M=r?t.width:parseFloat(o.width)-R-E,O=r?t.height:parseFloat(o.height)-z-y;if(n.has(t)){var k=n.get(t);if(k[0]===M&&k[1]===O)return}n.set(t,[M,O]);var S=Object.create(h.prototype);S.target=t,S.contentRect=new c(u,d,M,O),s.has(i)||(s.set(i,[]),p.add(i)),s.get(i).push(S)}))})),p.forEach((function(e){i.get(e).call(e,s.get(e),e)}))}return s.prototype.observe=function(i){if(i instanceof window.Element){r.has(i)||(r.set(i,new Set),o.add(i),a.set(i,window.getComputedStyle(i)));var n=r.get(i);n.has(this)||n.add(this),cancelAnimationFrame(t),t=requestAnimationFrame(d)}},s.prototype.unobserve=function(i){if(i instanceof window.Element&&r.has(i)){var n=r.get(i);n.has(this)&&(n.delete(this),n.size||(r.delete(i),o.delete(i))),n.size||r.delete(i),o.size||cancelAnimationFrame(t)}},A.DOMRectReadOnly=c,A.ResizeObserver=s,A.ResizeObserverEntry=h,A}; // eslint-disable-line
mpl.toolbar_items = [["Home", "Reset original view", "fa fa-home", "home"], ["Back", "Back to previous view", "fa fa-arrow-left", "back"], ["Forward", "Forward to next view", "fa fa-arrow-right", "forward"], ["", "", "", ""], ["Pan", "Left button pans, Right button zooms\nx/y fixes axis, CTRL fixes aspect", "fa fa-arrows", "pan"], ["Zoom", "Zoom to rectangle\nx/y fixes axis", "fa fa-square-o", "zoom"], ["", "", "", ""], ["Download", "Download plot", "fa fa-floppy-o", "download"]];

mpl.extensions = ["eps", "jpeg", "pgf", "pdf", "png", "ps", "raw", "svg", "tif", "webp"];

mpl.default_extension = "png";/* global mpl */

var comm_websocket_adapter = function (comm) {
    // Create a "websocket"-like object which calls the given IPython comm
    // object with the appropriate methods. Currently this is a non binary
    // socket, so there is still some room for performance tuning.
    var ws = {};

    ws.binaryType = comm.kernel.ws.binaryType;
    ws.readyState = comm.kernel.ws.readyState;
    function updateReadyState(_event) {
        if (comm.kernel.ws) {
            ws.readyState = comm.kernel.ws.readyState;
        } else {
            ws.readyState = 3; // Closed state.
        }
    }
    comm.kernel.ws.addEventListener('open', updateReadyState);
    comm.kernel.ws.addEventListener('close', updateReadyState);
    comm.kernel.ws.addEventListener('error', updateReadyState);

    ws.close = function () {
        comm.close();
    };
    ws.send = function (m) {
        //console.log('sending', m);
        comm.send(m);
    };
    // Register the callback with on_msg.
    comm.on_msg(function (msg) {
        //console.log('receiving', msg['content']['data'], msg);
        var data = msg['content']['data'];
        if (data['blob'] !== undefined) {
            data = {
                data: new Blob(msg['buffers'], { type: data['blob'] }),
            };
        }
        // Pass the mpl event to the overridden (by mpl) onmessage function.
        ws.onmessage(data);
    });
    return ws;
};

mpl.mpl_figure_comm = function (comm, msg) {
    // This is the function which gets called when the mpl process
    // starts-up an IPython Comm through the "matplotlib" channel.

    var id = msg.content.data.id;
    // Get hold of the div created by the display call when the Comm
    // socket was opened in Python.
    var element = document.getElementById(id);
    var ws_proxy = comm_websocket_adapter(comm);

    function ondownload(figure, _format) {
        window.open(figure.canvas.toDataURL());
    }

    var fig = new mpl.figure(id, ws_proxy, ondownload, element);

    // Call onopen now - mpl needs it, as it is assuming we've passed it a real
    // web socket which is closed, not our websocket->open comm proxy.
    ws_proxy.onopen();

    fig.parent_element = element;
    fig.cell_info = mpl.find_output_cell("<div id='" + id + "'></div>");
    if (!fig.cell_info) {
        console.error('Failed to find cell for figure', id, fig);
        return;
    }
    fig.cell_info[0].output_area.element.on(
        'cleared',
        { fig: fig },
        fig._remove_fig_handler
    );
};

mpl.figure.prototype.handle_close = function (fig, msg) {
    var width = fig.canvas.width / fig.ratio;
    fig.cell_info[0].output_area.element.off(
        'cleared',
        fig._remove_fig_handler
    );
    fig.resizeObserverInstance.unobserve(fig.canvas_div);

    // Update the output cell to use the data from the current canvas.
    fig.push_to_output();
    var dataURL = fig.canvas.toDataURL();
    // Re-enable the keyboard manager in IPython - without this line, in FF,
    // the notebook keyboard shortcuts fail.
    IPython.keyboard_manager.enable();
    fig.parent_element.innerHTML =
        '<img src="' + dataURL + '" width="' + width + '">';
    fig.close_ws(fig, msg);
};

mpl.figure.prototype.close_ws = function (fig, msg) {
    fig.send_message('closing', msg);
    // fig.ws.close()
};

mpl.figure.prototype.push_to_output = function (_remove_interactive) {
    // Turn the data on the canvas into data in the output cell.
    var width = this.canvas.width / this.ratio;
    var dataURL = this.canvas.toDataURL();
    this.cell_info[1]['text/html'] =
        '<img src="' + dataURL + '" width="' + width + '">';
};

mpl.figure.prototype.updated_canvas_event = function () {
    // Tell IPython that the notebook contents must change.
    IPython.notebook.set_dirty(true);
    this.send_message('ack', {});
    var fig = this;
    // Wait a second, then push the new image to the DOM so
    // that it is saved nicely (might be nice to debounce this).
    setTimeout(function () {
        fig.push_to_output();
    }, 1000);
};

mpl.figure.prototype._init_toolbar = function () {
    var fig = this;

    var toolbar = document.createElement('div');
    toolbar.classList = 'btn-toolbar';
    this.root.appendChild(toolbar);

    function on_click_closure(name) {
        return function (_event) {
            return fig.toolbar_button_onclick(name);
        };
    }

    function on_mouseover_closure(tooltip) {
        return function (event) {
            if (!event.currentTarget.disabled) {
                return fig.toolbar_button_onmouseover(tooltip);
            }
        };
    }

    fig.buttons = {};
    var buttonGroup = document.createElement('div');
    buttonGroup.classList = 'btn-group';
    var button;
    for (var toolbar_ind in mpl.toolbar_items) {
        var name = mpl.toolbar_items[toolbar_ind][0];
        var tooltip = mpl.toolbar_items[toolbar_ind][1];
        var image = mpl.toolbar_items[toolbar_ind][2];
        var method_name = mpl.toolbar_items[toolbar_ind][3];

        if (!name) {
            /* Instead of a spacer, we start a new button group. */
            if (buttonGroup.hasChildNodes()) {
                toolbar.appendChild(buttonGroup);
            }
            buttonGroup = document.createElement('div');
            buttonGroup.classList = 'btn-group';
            continue;
        }

        button = fig.buttons[name] = document.createElement('button');
        button.classList = 'btn btn-default';
        button.href = '#';
        button.title = name;
        button.innerHTML = '<i class="fa ' + image + ' fa-lg"></i>';
        button.addEventListener('click', on_click_closure(method_name));
        button.addEventListener('mouseover', on_mouseover_closure(tooltip));
        buttonGroup.appendChild(button);
    }

    if (buttonGroup.hasChildNodes()) {
        toolbar.appendChild(buttonGroup);
    }

    // Add the status bar.
    var status_bar = document.createElement('span');
    status_bar.classList = 'mpl-message pull-right';
    toolbar.appendChild(status_bar);
    this.message = status_bar;

    // Add the close button to the window.
    var buttongrp = document.createElement('div');
    buttongrp.classList = 'btn-group inline pull-right';
    button = document.createElement('button');
    button.classList = 'btn btn-mini btn-primary';
    button.href = '#';
    button.title = 'Stop Interaction';
    button.innerHTML = '<i class="fa fa-power-off icon-remove icon-large"></i>';
    button.addEventListener('click', function (_evt) {
        fig.handle_close(fig, {});
    });
    button.addEventListener(
        'mouseover',
        on_mouseover_closure('Stop Interaction')
    );
    buttongrp.appendChild(button);
    var titlebar = this.root.querySelector('.ui-dialog-titlebar');
    titlebar.insertBefore(buttongrp, titlebar.firstChild);
};

mpl.figure.prototype._remove_fig_handler = function (event) {
    var fig = event.data.fig;
    if (event.target !== this) {
        // Ignore bubbled events from children.
        return;
    }
    fig.close_ws(fig, {});
};

mpl.figure.prototype._root_extra_style = function (el) {
    el.style.boxSizing = 'content-box'; // override notebook setting of border-box.
};

mpl.figure.prototype._canvas_extra_style = function (el) {
    // this is important to make the div 'focusable
    el.setAttribute('tabindex', 0);
    // reach out to IPython and tell the keyboard manager to turn it's self
    // off when our div gets focus

    // location in version 3
    if (IPython.notebook.keyboard_manager) {
        IPython.notebook.keyboard_manager.register_events(el);
    } else {
        // location in version 2
        IPython.keyboard_manager.register_events(el);
    }
};

mpl.figure.prototype._key_event_extra = function (event, _name) {
    // Check for shift+enter
    if (event.shiftKey && event.which === 13) {
        this.canvas_div.blur();
        // select the cell after this one
        var index = IPython.notebook.find_cell_index(this.cell_info[0]);
        IPython.notebook.select(index + 1);
    }
};

mpl.figure.prototype.handle_save = function (fig, _msg) {
    fig.ondownload(fig, null);
};

mpl.find_output_cell = function (html_output) {
    // Return the cell and output element which can be found *uniquely* in the notebook.
    // Note - this is a bit hacky, but it is done because the "notebook_saving.Notebook"
    // IPython event is triggered only after the cells have been serialised, which for
    // our purposes (turning an active figure into a static one), is too late.
    var cells = IPython.notebook.get_cells();
    var ncells = cells.length;
    for (var i = 0; i < ncells; i++) {
        var cell = cells[i];
        if (cell.cell_type === 'code') {
            for (var j = 0; j < cell.output_area.outputs.length; j++) {
                var data = cell.output_area.outputs[j];
                if (data.data) {
                    // IPython >= 3 moved mimebundle to data attribute of output
                    data = data.data;
                }
                if (data['text/html'] === html_output) {
                    return [cell, data, j];
                }
            }
        }
    }
};

// Register the function which deals with the matplotlib target/channel.
// The kernel may be null if the page has been refreshed.
if (IPython.notebook.kernel !== null) {
    IPython.notebook.kernel.comm_manager.register_target(
        'matplotlib',
        mpl.mpl_figure_comm
    );
}

</script>
</div>
<div class="cell-output cell-output-display">
<div id="6f5711c2-7dfd-4d70-8923-4608110087f1"></div>
</div>
<div class="cell-output cell-output-display" data-execution_count="21">
<video width="640" height="640" controls="" autoplay="" loop="">
  <source type="video/mp4" src="data:video/mp4;base64,AAAAIGZ0eXBNNFYgAAACAE00ViBpc29taXNvMmF2YzEAAAAIZnJlZQAADLxtZGF0AAACrgYF//+q
3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE2NCByMzA5NSBiYWVlNDAwIC0gSC4yNjQvTVBF
Ry00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAyMiAtIGh0dHA6Ly93d3cudmlkZW9sYW4u
b3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTMgZGVibG9jaz0xOjA6MCBhbmFs
eXNlPTB4MzoweDExMyBtZT1oZXggc3VibWU9NyBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVk
X3JlZj0xIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MSA4eDhkY3Q9MSBjcW09MCBk
ZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0tMiB0aHJlYWRzPTMw
IGxvb2thaGVhZF90aHJlYWRzPTUgc2xpY2VkX3RocmVhZHM9MCBucj0wIGRlY2ltYXRlPTEgaW50
ZXJsYWNlZD0wIGJsdXJheV9jb21wYXQ9MCBjb25zdHJhaW5lZF9pbnRyYT0wIGJmcmFtZXM9MyBi
X3B5cmFtaWQ9MiBiX2FkYXB0PTEgYl9iaWFzPTAgZGlyZWN0PTEgd2VpZ2h0Yj0xIG9wZW5fZ29w
PTAgd2VpZ2h0cD0yIGtleWludD0yNTAga2V5aW50X21pbj01IHNjZW5lY3V0PTQwIGludHJhX3Jl
ZnJlc2g9MCByY19sb29rYWhlYWQ9NDAgcmM9Y3JmIG1idHJlZT0xIGNyZj0yMy4wIHFjb21wPTAu
NjAgcXBtaW49MCBxcG1heD02OSBxcHN0ZXA9NCBpcF9yYXRpbz0xLjQwIGFxPTE6MS4wMACAAAAF
7GWIhAAS//73rd+BTcBA7Wu6Vzi0y6uUND1R9pSmeLZIAAADAAADAAADAAAWkNGdDBVukodCQAAA
AwALkAB6gA4AAnYAlAAm3gAOPkSH5qVyhf34CrK4qwAAO0X/EjI+03r8feuTOdVpx2stzcQAAAaw
AvgB2Pu/RW4QzoE5pTtlcVZ5SDZHrS8/g4DZ7YZsGQoppPxTR1iDUnWOWlFyAAfeejr77y7MvbuO
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
AQAAAABMYXZmNjAuMy4xMDA=
">
  Your browser does not support the video tag.
</video>
</div>
</div>
<p>It looks easy to use. However, the default size of the video was too big, so I replaced the HTML tags to make it smaller. It seems to be usable in combination with <code>vmap</code> and <code>jit</code> for actual learning.</p>
</section>
<section id="lets-implement-ppo." class="level2">
<h2 class="anchored" data-anchor-id="lets-implement-ppo.">Let’s implement PPO.</h2>
<p>So, let’s try to learn this environment. Here we will implement <a href="https://arxiv.org/abs/1707.06347">PPO</a>, because it’s fast.</p>
<section id="input" class="level3">
<h3 class="anchored" data-anchor-id="input">Input</h3>
<p>Input as an array with <code>3x10x10</code> shape, each representing a 10x10 binary image of the position of the wall, the position of the agent, and the position of the goal, respectively.</p>
<div class="cell" data-tags="[]" data-execution_count="22">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jumanji.environments.routing.maze.types <span class="im">import</span> Observation, State</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> obs_to_image(obs: Observation) <span class="op">-&gt;</span> jax.Array:</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    walls <span class="op">=</span> obs.walls.astype(jnp.float32)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    agent <span class="op">=</span> jnp.zeros_like(walls).at[obs.agent_position].<span class="bu">set</span>(<span class="fl">1.0</span>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    target <span class="op">=</span> jnp.zeros_like(walls).at[obs.target_position].<span class="bu">set</span>(<span class="fl">1.0</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jnp.stack([walls, agent, target])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="network" class="level3">
<h3 class="anchored" data-anchor-id="network">Network</h3>
<p>I use a simple network with a 2D convolution layer, followed by ReLU activations and two linear layers. Policy and value networks share the first two layers, and the policy is modeled by a categorical distribution. To make things simpler, I will write the input and output sizes as <span class="math inline">\(3 \times 10 \times 10\)</span> and <span class="math inline">\(4\)</span> for the number of actions.</p>
<div class="cell" data-tags="[]" data-execution_count="164">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> NamedTuple</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jax.nn.initializers <span class="im">import</span> orthogonal</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PPONetOutput(NamedTuple):</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    policy_logits: jax.Array</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    value: jax.Array</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SoftmaxPPONet(eqx.Module):</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    torso: <span class="bu">list</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    value_head: eqx.nn.Linear</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    policy_head: eqx.nn.Linear</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, key: jax.Array) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>        key1, key2, key3, key4, key5 <span class="op">=</span> jax.random.split(key, <span class="dv">5</span>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Common layers</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.torso <span class="op">=</span> [</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>            eqx.nn.Conv2d(<span class="dv">3</span>, <span class="dv">1</span>, kernel_size<span class="op">=</span><span class="dv">3</span>, key<span class="op">=</span>key1),</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>            jax.nn.relu,</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>            jnp.ravel,</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>            eqx.nn.Linear(<span class="dv">64</span>, <span class="dv">64</span>, key<span class="op">=</span>key2),</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>            jax.nn.relu,</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.value_head <span class="op">=</span> eqx.nn.Linear(<span class="dv">64</span>, <span class="dv">1</span>, key<span class="op">=</span>key3)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>        policy_head <span class="op">=</span> eqx.nn.Linear(<span class="dv">64</span>, <span class="dv">4</span>, key<span class="op">=</span>key4)</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use small value for policy initialization</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.policy_head <span class="op">=</span> eqx.tree_at(</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> linear: linear.weight,</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>            policy_head,</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>            orthogonal(scale<span class="op">=</span><span class="fl">0.01</span>)(key5, policy_head.weight.shape),</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, x: jax.Array) <span class="op">-&gt;</span> PPONetOutput:</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> layer <span class="kw">in</span> <span class="va">self</span>.torso:</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> layer(x)</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>        value <span class="op">=</span> <span class="va">self</span>.value_head(x)</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>        policy_logits <span class="op">=</span> <span class="va">self</span>.policy_head(x)</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> PPONetOutput(policy_logits<span class="op">=</span>policy_logits, value<span class="op">=</span>value)</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> value(<span class="va">self</span>, x: jax.Array) <span class="op">-&gt;</span> jax.Array:</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> layer <span class="kw">in</span> <span class="va">self</span>.torso:</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> layer(x)</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.value_head(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="rollout" class="level3">
<h3 class="anchored" data-anchor-id="rollout">Rollout</h3>
<p>In PPO implementations, it is common to collect a history of environmental interaction about 500~8000 steps and use it to update the network several times. Here we use <a href="https://jax.readthedocs.io/en/latest/jaxpr.html#scan">jax.lax.scan</a> to implement a rollout that is faster than native Python for loop. While scan is super fast, its usage requires a bit of care. In particular, if you set the second output of the function that moves forward one step to <code>results: list[Result]</code>, keep in mind that the final return will be <code>Result(member1=stack([m1 for m1 in results.member1]), ...)</code> Also, since the argument of <code>exec_rollout</code> contains a <code>SoftmaxPPONet</code> which is an instance of <code>eqx.Module</code>, you can’t use <code>jax.jit</code> directly. Instead, you need to use <code>eqx.filter_jit</code> that decomposes the module to parameters and non-parameters automatically. Actions are sampled by a categorical distribution obtained by applying softmax to the output of the policy network, but since <code>Observation</code> contains an <code>action_mask</code> that tells you the direction in which you can move in the maze, you can mask the actions you cannot take with this by applying <code>-inf</code> to policy logits. In a simple environment, you don’t need to do this, but mazes with many walls are difficult to solve without this masking.</p>
<div class="cell" data-tags="[]" data-execution_count="165">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> chex</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="at">@chex.dataclass</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Rollout:</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Rollout buffer that stores the entire history of one rollout"""</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    observations: jax.Array</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    actions: jax.Array</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    action_masks: jax.Array</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    rewards: jax.Array</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    terminations: jax.Array</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    values: jax.Array</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    policy_logits: jax.Array</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mask_logits(policy_logits: jax.Array, action_mask: jax.Array) <span class="op">-&gt;</span> jax.Array:</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jax.lax.select(</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>        action_mask,</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>        policy_logits,</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>        jnp.ones_like(policy_logits) <span class="op">*</span> <span class="op">-</span>jnp.inf,</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>vmapped_obs2i <span class="op">=</span> jax.vmap(obs_to_image)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="at">@eqx.filter_jit</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> exec_rollout(</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    initial_state: State,</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    initial_obs: Observation,</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    env: jumanji.Environment,</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    network: SoftmaxPPONet,</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    prng_key: jax.Array,</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    n_rollout_steps: <span class="bu">int</span>,</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">tuple</span>[State, Rollout, Observation, jax.Array]:</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> step_rollout(</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>        carried: <span class="bu">tuple</span>[State, Observation],</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>        key: jax.Array,</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="bu">tuple</span>[<span class="bu">tuple</span>[State, jax.Array], Rollout]:</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>        state_t, obs_t <span class="op">=</span> carried</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>        obs_image <span class="op">=</span> vmapped_obs2i(obs_t)</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>        net_out <span class="op">=</span> jax.vmap(network)(obs_image)</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>        masked_logits <span class="op">=</span> mask_logits(net_out.policy_logits, obs_t.action_mask)</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>        actions <span class="op">=</span> jax.random.categorical(key, masked_logits, axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>        state_t1, timestep <span class="op">=</span> jax.vmap(env.step)(state_t, actions)</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>        rollout <span class="op">=</span> Rollout(</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>            observations<span class="op">=</span>obs_image,</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>            actions<span class="op">=</span>actions,</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>            action_masks<span class="op">=</span>obs_t.action_mask,</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>            rewards<span class="op">=</span>timestep.reward,</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>            terminations<span class="op">=</span><span class="fl">1.0</span> <span class="op">-</span> timestep.discount,</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>            values<span class="op">=</span>net_out.value,</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>            policy_logits<span class="op">=</span>masked_logits,</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (state_t1, timestep.observation), rollout</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>    (state, obs), rollout <span class="op">=</span> jax.lax.scan(</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>        step_rollout,</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>        (initial_state, initial_obs),</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>        jax.random.split(prng_key, n_rollout_steps),</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>    next_value <span class="op">=</span> jax.vmap(network.value)(vmapped_obs2i(obs))</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> state, rollout, obs, next_value</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s test it. The advantage of the jax environment is that you can easily vector-parallelize the environment with <code>jax.vmap</code>, so this time we will run it in 16 parallel. If you apply <code>vmap</code> to <code>reset</code> and give it 16 PRNGKeys, you will get 16 parallel <code>State</code>.</p>
<div class="cell" data-tags="[]" data-execution_count="145">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>key, net_key, reset_key, rollout_key <span class="op">=</span> jax.random.split(key, <span class="dv">4</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>pponet <span class="op">=</span> SoftmaxPPONet(net_key)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>initial_state, initial_timestep <span class="op">=</span> jax.vmap(env.reset)(jax.random.split(reset_key, <span class="dv">16</span>))</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>next_state, rollout, next_obs, next_value <span class="op">=</span> exec_rollout(</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    initial_state,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    initial_timestep.observation,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    env,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    pponet,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    rollout_key,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="dv">512</span>,</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>rollout.rewards.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="145">
<pre><code>(512, 16)</code></pre>
</div>
</div>
<p>We can confirm that the inputs are 16 in parallel, and each member of Rollout has <code>n. steps x n. env x ....</code> shape.</p>
</section>
<section id="learning" class="level3">
<h3 class="anchored" data-anchor-id="learning">Learning</h3>
<p>Now that the data has been collected, it is time to write the code to update the network. First, compute <a href="https://arxiv.org/abs/1506.02438">GAE</a>. Since it is unexpectedly a bottleneck, let’s speed it up with <a href="https://jax.readthedocs.io/en/latest/_autosummary/jax.lax.fori_loop.html#jax.lax.fori_loop"><code>fori_loop</code></a>.</p>
<div class="cell" data-tags="[]" data-execution_count="166">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="at">@chex.dataclass</span>(frozen<span class="op">=</span><span class="va">True</span>, mappable_dataclass<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Batch:</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Batch for PPO, indexable to get a minibatch."""</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    observations: jax.Array</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    action_masks: jax.Array</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    onehot_actions: jax.Array</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    rewards: jax.Array</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    advantages: jax.Array</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    value_targets: jax.Array</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    log_action_probs: jax.Array</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx: jax.Array):</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.__class__(  <span class="co"># type: ignore</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>            observations<span class="op">=</span><span class="va">self</span>.observations[idx],</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>            action_masks<span class="op">=</span><span class="va">self</span>.action_masks[idx],</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>            onehot_actions<span class="op">=</span><span class="va">self</span>.onehot_actions[idx],</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>            rewards<span class="op">=</span><span class="va">self</span>.rewards[idx],</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>            advantages<span class="op">=</span><span class="va">self</span>.advantages[idx],</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>            value_targets<span class="op">=</span><span class="va">self</span>.value_targets[idx],</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>            log_action_probs<span class="op">=</span><span class="va">self</span>.log_action_probs[idx],</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_gae(</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    r_t: jax.Array,</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    discount_t: jax.Array,</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    values: jax.Array,</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    lambda_: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> jax.Array:</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Efficiently compute generalized advantage estimator (GAE)"""</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    gamma_lambda_t <span class="op">=</span> discount_t <span class="op">*</span> lambda_</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    delta_t <span class="op">=</span> r_t <span class="op">+</span> discount_t <span class="op">*</span> values[<span class="dv">1</span>:] <span class="op">-</span> values[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> delta_t.shape[<span class="dv">0</span>]</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> update(i: <span class="bu">int</span>, advantage_t: jax.Array) <span class="op">-&gt;</span> jax.Array:</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> n <span class="op">-</span> i <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>        adv_t <span class="op">=</span> delta_t[t] <span class="op">+</span> gamma_lambda_t[t] <span class="op">*</span> advantage_t[t <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> advantage_t.at[t].<span class="bu">set</span>(adv_t)</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>    advantage_t <span class="op">=</span> jax.lax.fori_loop(<span class="dv">0</span>, n, update, jnp.zeros_like(values))</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> advantage_t[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a><span class="at">@eqx.filter_jit</span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_batch(</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>    rollout: Rollout,</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>    next_value: jax.Array,</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>    gamma: <span class="bu">float</span>,</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>    gae_lambda: <span class="bu">float</span>,</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Batch:</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>    all_values <span class="op">=</span> jnp.concatenate(</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>        [jnp.squeeze(rollout.values), next_value.reshape(<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>)]</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>    advantages <span class="op">=</span> compute_gae(</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>        rollout.rewards,</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set γ = 0 when the episode terminates</span></span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">1.0</span> <span class="op">-</span> rollout.terminations) <span class="op">*</span> gamma,</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>        all_values,</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>        gae_lambda,</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>    value_targets <span class="op">=</span> advantages <span class="op">+</span> all_values[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>    onehot_actions <span class="op">=</span> jax.nn.one_hot(rollout.actions, <span class="dv">4</span>)</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>    _, _, <span class="op">*</span>obs_shape <span class="op">=</span> rollout.observations.shape</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>    log_action_probs <span class="op">=</span> jnp.<span class="bu">sum</span>(</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>        jax.nn.log_softmax(rollout.policy_logits) <span class="op">*</span> onehot_actions,</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>        axis<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Batch(</span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>        observations<span class="op">=</span>rollout.observations.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="op">*</span>obs_shape),</span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>        action_masks<span class="op">=</span>rollout.action_masks.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>        onehot_actions<span class="op">=</span>onehot_actions.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>        rewards<span class="op">=</span>rollout.rewards.ravel(),</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>        advantages<span class="op">=</span>advantages.ravel(),</span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>        value_targets<span class="op">=</span>value_targets.ravel(),</span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>        log_action_probs<span class="op">=</span>log_action_probs.ravel(),</span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-tags="[]" data-execution_count="167">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>batch <span class="op">=</span> make_batch(rollout, next_value, <span class="fl">0.99</span>, <span class="fl">0.95</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>batch.advantages.shape, batch.onehot_actions.shape, batch.log_action_probs.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="167">
<pre><code>((8192,), (8192, 4), (8192,))</code></pre>
</div>
</div>
<p>Looks OK. Now we can sample a mini-batch from the <code>Batch</code> we created with this and update it with gradient descent to minimize the loss function. Here I use <a href="https://optax.readthedocs.io">optax</a>, which is a standard in the jax community. At this point, note the following three points.</p>
<ul>
<li>Use <code>eqx.filter_grad</code> instead of <code>jax.grad</code> as explained in the previous sections</li>
<li><code>SoftmaxPPONet</code> has types that cannot be used as <code>jax.jit</code> arguments, such as <code>jax.nn.relu</code>, so use <code>eqx.partition</code> to break them up before using them as <code>jax.lax.scan</code> arguments</li>
<li>Similarly, <code>SoftmaxPPONet</code> cannot be used as an argument to <code>optax</code> initialization/update functions as is, so it should be broken down with <code>eqx.partition</code> or <code>eqx.filter</code> to exclude members other than <code>jax.Array</code>.</li>
</ul>
<p>Also, if you want to use <code>jax.lax.scan</code> in a mini-batch update loop, there are several ways to do it. What I do here is that, assuming mini-batch size <span class="math inline">\(N\)</span>, number of updates <span class="math inline">\(M\)</span>, number of update epochs <span class="math inline">\(K\)</span> times, overall batch size <span class="math inline">\(N \times M\)</span>,</p>
<ol type="1">
<li>Make permutations of <span class="math inline">\(0, 1, 2, ... , NM - 1\)</span> <span class="math inline">\(K\)</span> times.</li>
<li>Make <span class="math inline">\(K\)</span> copies of <code>Batch</code> shuffled by the permutations we made</li>
<li>Concatenate each member with <code>jnp.concatenate</code> and reshape to an array with size <span class="math inline">\(MK \times N \times ...\)</span>.</li>
</ol>
<p>It’s a bit difficult, and you may not need to speed it up this fast. If you are worried about memory usage, you could write a <span class="math inline">\(K\)</span> loop in Python, but in this case, the input is <span class="math inline">\(3\times 10\times 10\)</span>, so it seems to be ok.</p>
<div class="cell" data-tags="[]" data-execution_count="168">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> optax</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> loss_function(</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    network: SoftmaxPPONet,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    batch: Batch,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    ppo_clip_eps: <span class="bu">float</span>,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> jax.Array:</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    net_out <span class="op">=</span> jax.vmap(network)(batch.observations)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Policy loss</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    log_pi <span class="op">=</span> jax.nn.log_softmax(</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>        jax.lax.select(</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>            batch.action_masks,</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>            net_out.policy_logits,</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>            jnp.ones_like(net_out.policy_logits <span class="op">*</span> <span class="op">-</span>jnp.inf),</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    log_action_probs <span class="op">=</span> jnp.<span class="bu">sum</span>(log_pi <span class="op">*</span> batch.onehot_actions, axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    policy_ratio <span class="op">=</span> jnp.exp(log_action_probs <span class="op">-</span> batch.log_action_probs)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    clipped_ratio <span class="op">=</span> jnp.clip(policy_ratio, <span class="fl">1.0</span> <span class="op">-</span> ppo_clip_eps, <span class="fl">1.0</span> <span class="op">+</span> ppo_clip_eps)</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    clipped_objective <span class="op">=</span> jnp.fmin(</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>        policy_ratio <span class="op">*</span> batch.advantages,</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>        clipped_ratio <span class="op">*</span> batch.advantages,</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>    policy_loss <span class="op">=</span> <span class="op">-</span>jnp.mean(clipped_objective)</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Value loss</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>    value_loss <span class="op">=</span> jnp.mean(<span class="fl">0.5</span> <span class="op">*</span> (net_out.value <span class="op">-</span> batch.value_targets) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Entropy regularization</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>    entropy <span class="op">=</span> jnp.mean(<span class="op">-</span>jnp.exp(log_pi) <span class="op">*</span> log_pi)</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> policy_loss <span class="op">+</span> value_loss <span class="op">-</span> <span class="fl">0.01</span> <span class="op">*</span> entropy</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>vmapped_permutation <span class="op">=</span> jax.vmap(jax.random.permutation, in_axes<span class="op">=</span>(<span class="dv">0</span>, <span class="va">None</span>), out_axes<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="at">@eqx.filter_jit</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> update_network(</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>    batch: Batch,</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>    network: SoftmaxPPONet,</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>    optax_update: optax.TransformUpdateFn,</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    opt_state: optax.OptState,</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    prng_key: jax.Array,</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>    minibatch_size: <span class="bu">int</span>,</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>    n_epochs: <span class="bu">int</span>,</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>    ppo_clip_eps: <span class="bu">float</span>,</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">tuple</span>[optax.OptState, SoftmaxPPONet]:</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare update function</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>    dynamic_net, static_net <span class="op">=</span> eqx.partition(network, eqx.is_array)</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> update_once(</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>        carried: <span class="bu">tuple</span>[optax.OptState, SoftmaxPPONet],</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>        batch: Batch,</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="bu">tuple</span>[<span class="bu">tuple</span>[optax.OptState, SoftmaxPPONet], <span class="va">None</span>]:</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>        opt_state, dynamic_net <span class="op">=</span> carried</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>        network <span class="op">=</span> eqx.combine(dynamic_net, static_net)</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>        grad <span class="op">=</span> eqx.filter_grad(loss_function)(network, batch, ppo_clip_eps)</span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>        updates, new_opt_state <span class="op">=</span> optax_update(grad, opt_state)</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>        dynamic_net <span class="op">=</span> optax.apply_updates(dynamic_net, updates)</span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (new_opt_state, dynamic_net), <span class="va">None</span></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare minibatches</span></span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>    batch_size <span class="op">=</span> batch.observations.shape[<span class="dv">0</span>]</span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>    permutations <span class="op">=</span> vmapped_permutation(jax.random.split(prng_key, n_epochs), batch_size)</span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>    minibatches <span class="op">=</span> jax.tree_map(</span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Here, x's shape is [batch_size, ...]</span></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: x[permutations].reshape(<span class="op">-</span><span class="dv">1</span>, minibatch_size, <span class="op">*</span>x.shape[<span class="dv">1</span>:]),</span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a>        batch,</span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update network n_epochs x n_minibatches times</span></span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>    (opt_state, updated_dynet), _ <span class="op">=</span> jax.lax.scan(</span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>        update_once,</span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a>        (opt_state, dynamic_net),</span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>        minibatches,</span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> opt_state, eqx.combine(updated_dynet, static_net)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>So now that we have all the components, let’s start learning. First, let’s try a simple maze with no walls. I copied and pasted <a href="https://github.com/instadeepai/jumanji/blob/v0.3.1/jumanji/environments/routing/maze/generator.py">junmanji’s default maze generator</a> and rewrote it. In this environment, the reward is given only at the goal, so the average return per episode is simply calculated by <span class="math inline">\(\frac{\sum R}{\mathrm{Num.~episodes}}\)</span>, which is used as a progress indicator. I selected each hyperparameter from my experience.</p>
<div class="cell" data-tags="[]">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jumanji.environments.routing.maze.generator <span class="im">import</span> Generator</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jumanji.environments.routing.maze.types <span class="im">import</span> Position, State</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TestGenerator(Generator):</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(num_rows<span class="op">=</span><span class="dv">10</span>, num_cols<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, key: chex.PRNGKey) <span class="op">-&gt;</span> State:</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        walls <span class="op">=</span> jnp.zeros((<span class="dv">10</span>, <span class="dv">10</span>), dtype<span class="op">=</span><span class="bu">bool</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        agent_position <span class="op">=</span> Position(row<span class="op">=</span><span class="dv">0</span>, col<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>        target_position <span class="op">=</span> Position(row<span class="op">=</span><span class="dv">9</span>, col<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Build the state.</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> State(</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>            agent_position<span class="op">=</span>agent_position,</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>            target_position<span class="op">=</span>target_position,</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>            walls<span class="op">=</span>walls,</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>            action_mask<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>            key<span class="op">=</span>key,</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>            step_count<span class="op">=</span>jnp.array(<span class="dv">0</span>, jnp.int32),</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-tags="[]" data-execution_count="202">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_training(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    key: jax.Array,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    adam_lr: <span class="bu">float</span> <span class="op">=</span> <span class="fl">3e-4</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    adam_eps: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1e-7</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    gamma: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.99</span>,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    gae_lambda: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    n_optim_epochs: <span class="bu">int</span> <span class="op">=</span> <span class="dv">10</span>,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    minibatch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1024</span>,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    n_agents: <span class="bu">int</span> <span class="op">=</span> <span class="dv">16</span>,</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    n_rollout_steps: <span class="bu">int</span> <span class="op">=</span> <span class="dv">512</span>,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    n_total_steps: <span class="bu">int</span> <span class="op">=</span> <span class="dv">16</span> <span class="op">*</span> <span class="dv">512</span> <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    ppo_clip_eps: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>env_kwargs,</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> SoftmaxPPONet:</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    key, net_key, reset_key <span class="op">=</span> jax.random.split(key, <span class="dv">3</span>)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    pponet <span class="op">=</span> SoftmaxPPONet(net_key)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    env <span class="op">=</span> AutoResetWrapper(jumanji.make(<span class="st">"Maze-v0"</span>, <span class="op">**</span>env_kwargs))</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    adam_init, adam_update <span class="op">=</span> optax.adam(adam_lr, eps<span class="op">=</span>adam_eps)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    opt_state <span class="op">=</span> adam_init(eqx.<span class="bu">filter</span>(pponet, eqx.is_array))</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    env_state, timestep <span class="op">=</span> jax.vmap(env.reset)(jax.random.split(reset_key, <span class="dv">16</span>))</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    obs <span class="op">=</span> timestep.observation</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    n_loop <span class="op">=</span> n_total_steps <span class="op">//</span> (n_agents <span class="op">*</span> n_rollout_steps)</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    return_reporting_interval <span class="op">=</span> <span class="dv">1</span> <span class="cf">if</span> n_loop <span class="op">&lt;</span> <span class="dv">10</span> <span class="cf">else</span> n_loop <span class="op">//</span> <span class="dv">10</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    n_episodes, reward_sum <span class="op">=</span> <span class="fl">0.0</span>, <span class="fl">0.0</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_loop):</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>        key, rollout_key, update_key <span class="op">=</span> jax.random.split(key, <span class="dv">3</span>)</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>        env_state, rollout, obs, next_value <span class="op">=</span> exec_rollout(</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>            env_state,</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>            obs,</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>            env,</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>            pponet,</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>            rollout_key,</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>            n_rollout_steps,</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>        batch <span class="op">=</span> make_batch(rollout, next_value, gamma, gae_lambda)</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>        opt_state, pponet <span class="op">=</span> update_network(</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>            batch,</span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>            pponet,</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>            adam_update,</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>            opt_state,</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>            update_key,</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>            minibatch_size,</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>            n_optim_epochs,</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>            ppo_clip_eps,</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>        n_episodes <span class="op">+=</span> jnp.<span class="bu">sum</span>(rollout.terminations).item()</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>        reward_sum <span class="op">+=</span> jnp.<span class="bu">sum</span>(rollout.rewards).item()</span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> (i <span class="op">%</span> return_reporting_interval <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Mean episodic return: </span><span class="sc">{</span>reward_sum <span class="op">/</span> n_episodes<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>            n_episodes <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>            reward_sum <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pponet</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-tags="[]" data-execution_count="204">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>started <span class="op">=</span> datetime.datetime.now()</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>key, training_key <span class="op">=</span> jax.random.split(key)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>trained_net <span class="op">=</span> run_training(training_key, n_total_steps<span class="op">=</span><span class="dv">16</span> <span class="op">*</span> <span class="dv">512</span> <span class="op">*</span> <span class="dv">10</span>, generator<span class="op">=</span>TestGenerator())</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>elapsed <span class="op">=</span> datetime.datetime.now() <span class="op">-</span> started</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Elapsed time: </span><span class="sc">{</span>elapsed<span class="sc">.</span>total_seconds()<span class="sc">:.2}</span><span class="ss">s"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Mean episodic return: 0.40782122905027934
Mean episodic return: 0.967741935483871
Mean episodic return: 1.0
Mean episodic return: 1.0
Mean episodic return: 1.0
Mean episodic return: 1.0
Mean episodic return: 1.0
Mean episodic return: 1.0
Mean episodic return: 1.0
Elapsed time: 3.2s</code></pre>
</div>
</div>
<p>About 80,000 steps were learned in a little over 3 seconds. That’s fast. Let’s see what the trained agent looks like.</p>
<div class="cell" data-execution_count="207">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="at">@eqx.filter_jit</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualization_rollout(</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    key: jax.random.PRNGKey,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    pponet: SoftmaxPPONet,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    env: jumanji.Environment,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    n_steps: <span class="bu">int</span>,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">list</span>[State]:</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> step_rollout(</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>        carried: <span class="bu">tuple</span>[State, Observation],</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>        key: jax.Array,</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="bu">tuple</span>[<span class="bu">tuple</span>[State, jax.Array], State]:</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>        state_t, obs_t <span class="op">=</span> carried</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>        obs_image <span class="op">=</span> obs_to_image(obs_t)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>        net_out <span class="op">=</span> pponet(obs_image)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>        action, _ <span class="op">=</span> sample_action(key, net_out.policy_logits, obs_t.action_mask)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>        state_t1, timestep <span class="op">=</span> env.step(state_t, action)</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (state_t1, timestep.observation), state_t1</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    initial_state, timestep <span class="op">=</span> env.reset(key)</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    _, states <span class="op">=</span> jax.lax.scan(</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>        step_rollout,</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>        (initial_state, timestep.observation),</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>        jax.random.split(key, n_steps),</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>    leaves, treedef <span class="op">=</span> jax.tree_util.tree_flatten(states)</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [initial_state] <span class="op">+</span> [treedef.unflatten(leaf) <span class="cf">for</span> leaf <span class="kw">in</span> <span class="bu">zip</span>(<span class="op">*</span>leaves)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-tags="[]" data-execution_count="208">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>env <span class="op">=</span> AutoResetWrapper(jumanji.make(<span class="st">"Maze-v0"</span>, generator<span class="op">=</span>TestGenerator()))</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>key, eval_key <span class="op">=</span> jax.random.split(key)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>states <span class="op">=</span> visualization_rollout(eval_key, trained_net, env, <span class="dv">40</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>anim <span class="op">=</span> env.animate(states)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>HTML(anim.to_html5_video().replace(<span class="st">'="1000"'</span>, <span class="st">'="640"'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/javascript">
/* Put everything inside the global mpl namespace */
/* global mpl */
window.mpl = {};

mpl.get_websocket_type = function () {
    if (typeof WebSocket !== 'undefined') {
        return WebSocket;
    } else if (typeof MozWebSocket !== 'undefined') {
        return MozWebSocket;
    } else {
        alert(
            'Your browser does not have WebSocket support. ' +
                'Please try Chrome, Safari or Firefox ≥ 6. ' +
                'Firefox 4 and 5 are also supported but you ' +
                'have to enable WebSockets in about:config.'
        );
    }
};

mpl.figure = function (figure_id, websocket, ondownload, parent_element) {
    this.id = figure_id;

    this.ws = websocket;

    this.supports_binary = this.ws.binaryType !== undefined;

    if (!this.supports_binary) {
        var warnings = document.getElementById('mpl-warnings');
        if (warnings) {
            warnings.style.display = 'block';
            warnings.textContent =
                'This browser does not support binary websocket messages. ' +
                'Performance may be slow.';
        }
    }

    this.imageObj = new Image();

    this.context = undefined;
    this.message = undefined;
    this.canvas = undefined;
    this.rubberband_canvas = undefined;
    this.rubberband_context = undefined;
    this.format_dropdown = undefined;

    this.image_mode = 'full';

    this.root = document.createElement('div');
    this.root.setAttribute('style', 'display: inline-block');
    this._root_extra_style(this.root);

    parent_element.appendChild(this.root);

    this._init_header(this);
    this._init_canvas(this);
    this._init_toolbar(this);

    var fig = this;

    this.waiting = false;

    this.ws.onopen = function () {
        fig.send_message('supports_binary', { value: fig.supports_binary });
        fig.send_message('send_image_mode', {});
        if (fig.ratio !== 1) {
            fig.send_message('set_device_pixel_ratio', {
                device_pixel_ratio: fig.ratio,
            });
        }
        fig.send_message('refresh', {});
    };

    this.imageObj.onload = function () {
        if (fig.image_mode === 'full') {
            // Full images could contain transparency (where diff images
            // almost always do), so we need to clear the canvas so that
            // there is no ghosting.
            fig.context.clearRect(0, 0, fig.canvas.width, fig.canvas.height);
        }
        fig.context.drawImage(fig.imageObj, 0, 0);
    };

    this.imageObj.onunload = function () {
        fig.ws.close();
    };

    this.ws.onmessage = this._make_on_message_function(this);

    this.ondownload = ondownload;
};

mpl.figure.prototype._init_header = function () {
    var titlebar = document.createElement('div');
    titlebar.classList =
        'ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix';
    var titletext = document.createElement('div');
    titletext.classList = 'ui-dialog-title';
    titletext.setAttribute(
        'style',
        'width: 100%; text-align: center; padding: 3px;'
    );
    titlebar.appendChild(titletext);
    this.root.appendChild(titlebar);
    this.header = titletext;
};

mpl.figure.prototype._canvas_extra_style = function (_canvas_div) {};

mpl.figure.prototype._root_extra_style = function (_canvas_div) {};

mpl.figure.prototype._init_canvas = function () {
    var fig = this;

    var canvas_div = (this.canvas_div = document.createElement('div'));
    canvas_div.setAttribute('tabindex', '0');
    canvas_div.setAttribute(
        'style',
        'border: 1px solid #ddd;' +
            'box-sizing: content-box;' +
            'clear: both;' +
            'min-height: 1px;' +
            'min-width: 1px;' +
            'outline: 0;' +
            'overflow: hidden;' +
            'position: relative;' +
            'resize: both;' +
            'z-index: 2;'
    );

    function on_keyboard_event_closure(name) {
        return function (event) {
            return fig.key_event(event, name);
        };
    }

    canvas_div.addEventListener(
        'keydown',
        on_keyboard_event_closure('key_press')
    );
    canvas_div.addEventListener(
        'keyup',
        on_keyboard_event_closure('key_release')
    );

    this._canvas_extra_style(canvas_div);
    this.root.appendChild(canvas_div);

    var canvas = (this.canvas = document.createElement('canvas'));
    canvas.classList.add('mpl-canvas');
    canvas.setAttribute(
        'style',
        'box-sizing: content-box;' +
            'pointer-events: none;' +
            'position: relative;' +
            'z-index: 0;'
    );

    this.context = canvas.getContext('2d');

    var backingStore =
        this.context.backingStorePixelRatio ||
        this.context.webkitBackingStorePixelRatio ||
        this.context.mozBackingStorePixelRatio ||
        this.context.msBackingStorePixelRatio ||
        this.context.oBackingStorePixelRatio ||
        this.context.backingStorePixelRatio ||
        1;

    this.ratio = (window.devicePixelRatio || 1) / backingStore;

    var rubberband_canvas = (this.rubberband_canvas = document.createElement(
        'canvas'
    ));
    rubberband_canvas.setAttribute(
        'style',
        'box-sizing: content-box;' +
            'left: 0;' +
            'pointer-events: none;' +
            'position: absolute;' +
            'top: 0;' +
            'z-index: 1;'
    );

    // Apply a ponyfill if ResizeObserver is not implemented by browser.
    if (this.ResizeObserver === undefined) {
        if (window.ResizeObserver !== undefined) {
            this.ResizeObserver = window.ResizeObserver;
        } else {
            var obs = _JSXTOOLS_RESIZE_OBSERVER({});
            this.ResizeObserver = obs.ResizeObserver;
        }
    }

    this.resizeObserverInstance = new this.ResizeObserver(function (entries) {
        var nentries = entries.length;
        for (var i = 0; i < nentries; i++) {
            var entry = entries[i];
            var width, height;
            if (entry.contentBoxSize) {
                if (entry.contentBoxSize instanceof Array) {
                    // Chrome 84 implements new version of spec.
                    width = entry.contentBoxSize[0].inlineSize;
                    height = entry.contentBoxSize[0].blockSize;
                } else {
                    // Firefox implements old version of spec.
                    width = entry.contentBoxSize.inlineSize;
                    height = entry.contentBoxSize.blockSize;
                }
            } else {
                // Chrome <84 implements even older version of spec.
                width = entry.contentRect.width;
                height = entry.contentRect.height;
            }

            // Keep the size of the canvas and rubber band canvas in sync with
            // the canvas container.
            if (entry.devicePixelContentBoxSize) {
                // Chrome 84 implements new version of spec.
                canvas.setAttribute(
                    'width',
                    entry.devicePixelContentBoxSize[0].inlineSize
                );
                canvas.setAttribute(
                    'height',
                    entry.devicePixelContentBoxSize[0].blockSize
                );
            } else {
                canvas.setAttribute('width', width * fig.ratio);
                canvas.setAttribute('height', height * fig.ratio);
            }
            /* This rescales the canvas back to display pixels, so that it
             * appears correct on HiDPI screens. */
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';

            rubberband_canvas.setAttribute('width', width);
            rubberband_canvas.setAttribute('height', height);

            // And update the size in Python. We ignore the initial 0/0 size
            // that occurs as the element is placed into the DOM, which should
            // otherwise not happen due to the minimum size styling.
            if (fig.ws.readyState == 1 && width != 0 && height != 0) {
                fig.request_resize(width, height);
            }
        }
    });
    this.resizeObserverInstance.observe(canvas_div);

    function on_mouse_event_closure(name) {
        /* User Agent sniffing is bad, but WebKit is busted:
         * https://bugs.webkit.org/show_bug.cgi?id=144526
         * https://bugs.webkit.org/show_bug.cgi?id=181818
         * The worst that happens here is that they get an extra browser
         * selection when dragging, if this check fails to catch them.
         */
        var UA = navigator.userAgent;
        var isWebKit = /AppleWebKit/.test(UA) && !/Chrome/.test(UA);
        if(isWebKit) {
            return function (event) {
                /* This prevents the web browser from automatically changing to
                 * the text insertion cursor when the button is pressed. We
                 * want to control all of the cursor setting manually through
                 * the 'cursor' event from matplotlib */
                event.preventDefault()
                return fig.mouse_event(event, name);
            };
        } else {
            return function (event) {
                return fig.mouse_event(event, name);
            };
        }
    }

    canvas_div.addEventListener(
        'mousedown',
        on_mouse_event_closure('button_press')
    );
    canvas_div.addEventListener(
        'mouseup',
        on_mouse_event_closure('button_release')
    );
    canvas_div.addEventListener(
        'dblclick',
        on_mouse_event_closure('dblclick')
    );
    // Throttle sequential mouse events to 1 every 20ms.
    canvas_div.addEventListener(
        'mousemove',
        on_mouse_event_closure('motion_notify')
    );

    canvas_div.addEventListener(
        'mouseenter',
        on_mouse_event_closure('figure_enter')
    );
    canvas_div.addEventListener(
        'mouseleave',
        on_mouse_event_closure('figure_leave')
    );

    canvas_div.addEventListener('wheel', function (event) {
        if (event.deltaY < 0) {
            event.step = 1;
        } else {
            event.step = -1;
        }
        on_mouse_event_closure('scroll')(event);
    });

    canvas_div.appendChild(canvas);
    canvas_div.appendChild(rubberband_canvas);

    this.rubberband_context = rubberband_canvas.getContext('2d');
    this.rubberband_context.strokeStyle = '#000000';

    this._resize_canvas = function (width, height, forward) {
        if (forward) {
            canvas_div.style.width = width + 'px';
            canvas_div.style.height = height + 'px';
        }
    };

    // Disable right mouse context menu.
    canvas_div.addEventListener('contextmenu', function (_e) {
        event.preventDefault();
        return false;
    });

    function set_focus() {
        canvas.focus();
        canvas_div.focus();
    }

    window.setTimeout(set_focus, 100);
};

mpl.figure.prototype._init_toolbar = function () {
    var fig = this;

    var toolbar = document.createElement('div');
    toolbar.classList = 'mpl-toolbar';
    this.root.appendChild(toolbar);

    function on_click_closure(name) {
        return function (_event) {
            return fig.toolbar_button_onclick(name);
        };
    }

    function on_mouseover_closure(tooltip) {
        return function (event) {
            if (!event.currentTarget.disabled) {
                return fig.toolbar_button_onmouseover(tooltip);
            }
        };
    }

    fig.buttons = {};
    var buttonGroup = document.createElement('div');
    buttonGroup.classList = 'mpl-button-group';
    for (var toolbar_ind in mpl.toolbar_items) {
        var name = mpl.toolbar_items[toolbar_ind][0];
        var tooltip = mpl.toolbar_items[toolbar_ind][1];
        var image = mpl.toolbar_items[toolbar_ind][2];
        var method_name = mpl.toolbar_items[toolbar_ind][3];

        if (!name) {
            /* Instead of a spacer, we start a new button group. */
            if (buttonGroup.hasChildNodes()) {
                toolbar.appendChild(buttonGroup);
            }
            buttonGroup = document.createElement('div');
            buttonGroup.classList = 'mpl-button-group';
            continue;
        }

        var button = (fig.buttons[name] = document.createElement('button'));
        button.classList = 'mpl-widget';
        button.setAttribute('role', 'button');
        button.setAttribute('aria-disabled', 'false');
        button.addEventListener('click', on_click_closure(method_name));
        button.addEventListener('mouseover', on_mouseover_closure(tooltip));

        var icon_img = document.createElement('img');
        icon_img.src = '_images/' + image + '.png';
        icon_img.srcset = '_images/' + image + '_large.png 2x';
        icon_img.alt = tooltip;
        button.appendChild(icon_img);

        buttonGroup.appendChild(button);
    }

    if (buttonGroup.hasChildNodes()) {
        toolbar.appendChild(buttonGroup);
    }

    var fmt_picker = document.createElement('select');
    fmt_picker.classList = 'mpl-widget';
    toolbar.appendChild(fmt_picker);
    this.format_dropdown = fmt_picker;

    for (var ind in mpl.extensions) {
        var fmt = mpl.extensions[ind];
        var option = document.createElement('option');
        option.selected = fmt === mpl.default_extension;
        option.innerHTML = fmt;
        fmt_picker.appendChild(option);
    }

    var status_bar = document.createElement('span');
    status_bar.classList = 'mpl-message';
    toolbar.appendChild(status_bar);
    this.message = status_bar;
};

mpl.figure.prototype.request_resize = function (x_pixels, y_pixels) {
    // Request matplotlib to resize the figure. Matplotlib will then trigger a resize in the client,
    // which will in turn request a refresh of the image.
    this.send_message('resize', { width: x_pixels, height: y_pixels });
};

mpl.figure.prototype.send_message = function (type, properties) {
    properties['type'] = type;
    properties['figure_id'] = this.id;
    this.ws.send(JSON.stringify(properties));
};

mpl.figure.prototype.send_draw_message = function () {
    if (!this.waiting) {
        this.waiting = true;
        this.ws.send(JSON.stringify({ type: 'draw', figure_id: this.id }));
    }
};

mpl.figure.prototype.handle_save = function (fig, _msg) {
    var format_dropdown = fig.format_dropdown;
    var format = format_dropdown.options[format_dropdown.selectedIndex].value;
    fig.ondownload(fig, format);
};

mpl.figure.prototype.handle_resize = function (fig, msg) {
    var size = msg['size'];
    if (size[0] !== fig.canvas.width || size[1] !== fig.canvas.height) {
        fig._resize_canvas(size[0], size[1], msg['forward']);
        fig.send_message('refresh', {});
    }
};

mpl.figure.prototype.handle_rubberband = function (fig, msg) {
    var x0 = msg['x0'] / fig.ratio;
    var y0 = (fig.canvas.height - msg['y0']) / fig.ratio;
    var x1 = msg['x1'] / fig.ratio;
    var y1 = (fig.canvas.height - msg['y1']) / fig.ratio;
    x0 = Math.floor(x0) + 0.5;
    y0 = Math.floor(y0) + 0.5;
    x1 = Math.floor(x1) + 0.5;
    y1 = Math.floor(y1) + 0.5;
    var min_x = Math.min(x0, x1);
    var min_y = Math.min(y0, y1);
    var width = Math.abs(x1 - x0);
    var height = Math.abs(y1 - y0);

    fig.rubberband_context.clearRect(
        0,
        0,
        fig.canvas.width / fig.ratio,
        fig.canvas.height / fig.ratio
    );

    fig.rubberband_context.strokeRect(min_x, min_y, width, height);
};

mpl.figure.prototype.handle_figure_label = function (fig, msg) {
    // Updates the figure title.
    fig.header.textContent = msg['label'];
};

mpl.figure.prototype.handle_cursor = function (fig, msg) {
    fig.canvas_div.style.cursor = msg['cursor'];
};

mpl.figure.prototype.handle_message = function (fig, msg) {
    fig.message.textContent = msg['message'];
};

mpl.figure.prototype.handle_draw = function (fig, _msg) {
    // Request the server to send over a new figure.
    fig.send_draw_message();
};

mpl.figure.prototype.handle_image_mode = function (fig, msg) {
    fig.image_mode = msg['mode'];
};

mpl.figure.prototype.handle_history_buttons = function (fig, msg) {
    for (var key in msg) {
        if (!(key in fig.buttons)) {
            continue;
        }
        fig.buttons[key].disabled = !msg[key];
        fig.buttons[key].setAttribute('aria-disabled', !msg[key]);
    }
};

mpl.figure.prototype.handle_navigate_mode = function (fig, msg) {
    if (msg['mode'] === 'PAN') {
        fig.buttons['Pan'].classList.add('active');
        fig.buttons['Zoom'].classList.remove('active');
    } else if (msg['mode'] === 'ZOOM') {
        fig.buttons['Pan'].classList.remove('active');
        fig.buttons['Zoom'].classList.add('active');
    } else {
        fig.buttons['Pan'].classList.remove('active');
        fig.buttons['Zoom'].classList.remove('active');
    }
};

mpl.figure.prototype.updated_canvas_event = function () {
    // Called whenever the canvas gets updated.
    this.send_message('ack', {});
};

// A function to construct a web socket function for onmessage handling.
// Called in the figure constructor.
mpl.figure.prototype._make_on_message_function = function (fig) {
    return function socket_on_message(evt) {
        if (evt.data instanceof Blob) {
            var img = evt.data;
            if (img.type !== 'image/png') {
                /* FIXME: We get "Resource interpreted as Image but
                 * transferred with MIME type text/plain:" errors on
                 * Chrome.  But how to set the MIME type?  It doesn't seem
                 * to be part of the websocket stream */
                img.type = 'image/png';
            }

            /* Free the memory for the previous frames */
            if (fig.imageObj.src) {
                (window.URL || window.webkitURL).revokeObjectURL(
                    fig.imageObj.src
                );
            }

            fig.imageObj.src = (window.URL || window.webkitURL).createObjectURL(
                img
            );
            fig.updated_canvas_event();
            fig.waiting = false;
            return;
        } else if (
            typeof evt.data === 'string' &&
            evt.data.slice(0, 21) === 'data:image/png;base64'
        ) {
            fig.imageObj.src = evt.data;
            fig.updated_canvas_event();
            fig.waiting = false;
            return;
        }

        var msg = JSON.parse(evt.data);
        var msg_type = msg['type'];

        // Call the  "handle_{type}" callback, which takes
        // the figure and JSON message as its only arguments.
        try {
            var callback = fig['handle_' + msg_type];
        } catch (e) {
            console.log(
                "No handler for the '" + msg_type + "' message type: ",
                msg
            );
            return;
        }

        if (callback) {
            try {
                // console.log("Handling '" + msg_type + "' message: ", msg);
                callback(fig, msg);
            } catch (e) {
                console.log(
                    "Exception inside the 'handler_" + msg_type + "' callback:",
                    e,
                    e.stack,
                    msg
                );
            }
        }
    };
};

function getModifiers(event) {
    var mods = [];
    if (event.ctrlKey) {
        mods.push('ctrl');
    }
    if (event.altKey) {
        mods.push('alt');
    }
    if (event.shiftKey) {
        mods.push('shift');
    }
    if (event.metaKey) {
        mods.push('meta');
    }
    return mods;
}

/*
 * return a copy of an object with only non-object keys
 * we need this to avoid circular references
 * https://stackoverflow.com/a/24161582/3208463
 */
function simpleKeys(original) {
    return Object.keys(original).reduce(function (obj, key) {
        if (typeof original[key] !== 'object') {
            obj[key] = original[key];
        }
        return obj;
    }, {});
}

mpl.figure.prototype.mouse_event = function (event, name) {
    if (name === 'button_press') {
        this.canvas.focus();
        this.canvas_div.focus();
    }

    // from https://stackoverflow.com/q/1114465
    var boundingRect = this.canvas.getBoundingClientRect();
    var x = (event.clientX - boundingRect.left) * this.ratio;
    var y = (event.clientY - boundingRect.top) * this.ratio;

    this.send_message(name, {
        x: x,
        y: y,
        button: event.button,
        step: event.step,
        modifiers: getModifiers(event),
        guiEvent: simpleKeys(event),
    });

    return false;
};

mpl.figure.prototype._key_event_extra = function (_event, _name) {
    // Handle any extra behaviour associated with a key event
};

mpl.figure.prototype.key_event = function (event, name) {
    // Prevent repeat events
    if (name === 'key_press') {
        if (event.key === this._key) {
            return;
        } else {
            this._key = event.key;
        }
    }
    if (name === 'key_release') {
        this._key = null;
    }

    var value = '';
    if (event.ctrlKey && event.key !== 'Control') {
        value += 'ctrl+';
    }
    else if (event.altKey && event.key !== 'Alt') {
        value += 'alt+';
    }
    else if (event.shiftKey && event.key !== 'Shift') {
        value += 'shift+';
    }

    value += 'k' + event.key;

    this._key_event_extra(event, name);

    this.send_message(name, { key: value, guiEvent: simpleKeys(event) });
    return false;
};

mpl.figure.prototype.toolbar_button_onclick = function (name) {
    if (name === 'download') {
        this.handle_save(this, null);
    } else {
        this.send_message('toolbar_button', { name: name });
    }
};

mpl.figure.prototype.toolbar_button_onmouseover = function (tooltip) {
    this.message.textContent = tooltip;
};

///////////////// REMAINING CONTENT GENERATED BY embed_js.py /////////////////
// prettier-ignore
var _JSXTOOLS_RESIZE_OBSERVER=function(A){var t,i=new WeakMap,n=new WeakMap,a=new WeakMap,r=new WeakMap,o=new Set;function s(e){if(!(this instanceof s))throw new TypeError("Constructor requires 'new' operator");i.set(this,e)}function h(){throw new TypeError("Function is not a constructor")}function c(e,t,i,n){e=0 in arguments?Number(arguments[0]):0,t=1 in arguments?Number(arguments[1]):0,i=2 in arguments?Number(arguments[2]):0,n=3 in arguments?Number(arguments[3]):0,this.right=(this.x=this.left=e)+(this.width=i),this.bottom=(this.y=this.top=t)+(this.height=n),Object.freeze(this)}function d(){t=requestAnimationFrame(d);var s=new WeakMap,p=new Set;o.forEach((function(t){r.get(t).forEach((function(i){var r=t instanceof window.SVGElement,o=a.get(t),d=r?0:parseFloat(o.paddingTop),f=r?0:parseFloat(o.paddingRight),l=r?0:parseFloat(o.paddingBottom),u=r?0:parseFloat(o.paddingLeft),g=r?0:parseFloat(o.borderTopWidth),m=r?0:parseFloat(o.borderRightWidth),w=r?0:parseFloat(o.borderBottomWidth),b=u+f,F=d+l,v=(r?0:parseFloat(o.borderLeftWidth))+m,W=g+w,y=r?0:t.offsetHeight-W-t.clientHeight,E=r?0:t.offsetWidth-v-t.clientWidth,R=b+v,z=F+W,M=r?t.width:parseFloat(o.width)-R-E,O=r?t.height:parseFloat(o.height)-z-y;if(n.has(t)){var k=n.get(t);if(k[0]===M&&k[1]===O)return}n.set(t,[M,O]);var S=Object.create(h.prototype);S.target=t,S.contentRect=new c(u,d,M,O),s.has(i)||(s.set(i,[]),p.add(i)),s.get(i).push(S)}))})),p.forEach((function(e){i.get(e).call(e,s.get(e),e)}))}return s.prototype.observe=function(i){if(i instanceof window.Element){r.has(i)||(r.set(i,new Set),o.add(i),a.set(i,window.getComputedStyle(i)));var n=r.get(i);n.has(this)||n.add(this),cancelAnimationFrame(t),t=requestAnimationFrame(d)}},s.prototype.unobserve=function(i){if(i instanceof window.Element&&r.has(i)){var n=r.get(i);n.has(this)&&(n.delete(this),n.size||(r.delete(i),o.delete(i))),n.size||r.delete(i),o.size||cancelAnimationFrame(t)}},A.DOMRectReadOnly=c,A.ResizeObserver=s,A.ResizeObserverEntry=h,A}; // eslint-disable-line
mpl.toolbar_items = [["Home", "Reset original view", "fa fa-home", "home"], ["Back", "Back to previous view", "fa fa-arrow-left", "back"], ["Forward", "Forward to next view", "fa fa-arrow-right", "forward"], ["", "", "", ""], ["Pan", "Left button pans, Right button zooms\nx/y fixes axis, CTRL fixes aspect", "fa fa-arrows", "pan"], ["Zoom", "Zoom to rectangle\nx/y fixes axis", "fa fa-square-o", "zoom"], ["", "", "", ""], ["Download", "Download plot", "fa fa-floppy-o", "download"]];

mpl.extensions = ["eps", "jpeg", "pgf", "pdf", "png", "ps", "raw", "svg", "tif", "webp"];

mpl.default_extension = "png";/* global mpl */

var comm_websocket_adapter = function (comm) {
    // Create a "websocket"-like object which calls the given IPython comm
    // object with the appropriate methods. Currently this is a non binary
    // socket, so there is still some room for performance tuning.
    var ws = {};

    ws.binaryType = comm.kernel.ws.binaryType;
    ws.readyState = comm.kernel.ws.readyState;
    function updateReadyState(_event) {
        if (comm.kernel.ws) {
            ws.readyState = comm.kernel.ws.readyState;
        } else {
            ws.readyState = 3; // Closed state.
        }
    }
    comm.kernel.ws.addEventListener('open', updateReadyState);
    comm.kernel.ws.addEventListener('close', updateReadyState);
    comm.kernel.ws.addEventListener('error', updateReadyState);

    ws.close = function () {
        comm.close();
    };
    ws.send = function (m) {
        //console.log('sending', m);
        comm.send(m);
    };
    // Register the callback with on_msg.
    comm.on_msg(function (msg) {
        //console.log('receiving', msg['content']['data'], msg);
        var data = msg['content']['data'];
        if (data['blob'] !== undefined) {
            data = {
                data: new Blob(msg['buffers'], { type: data['blob'] }),
            };
        }
        // Pass the mpl event to the overridden (by mpl) onmessage function.
        ws.onmessage(data);
    });
    return ws;
};

mpl.mpl_figure_comm = function (comm, msg) {
    // This is the function which gets called when the mpl process
    // starts-up an IPython Comm through the "matplotlib" channel.

    var id = msg.content.data.id;
    // Get hold of the div created by the display call when the Comm
    // socket was opened in Python.
    var element = document.getElementById(id);
    var ws_proxy = comm_websocket_adapter(comm);

    function ondownload(figure, _format) {
        window.open(figure.canvas.toDataURL());
    }

    var fig = new mpl.figure(id, ws_proxy, ondownload, element);

    // Call onopen now - mpl needs it, as it is assuming we've passed it a real
    // web socket which is closed, not our websocket->open comm proxy.
    ws_proxy.onopen();

    fig.parent_element = element;
    fig.cell_info = mpl.find_output_cell("<div id='" + id + "'></div>");
    if (!fig.cell_info) {
        console.error('Failed to find cell for figure', id, fig);
        return;
    }
    fig.cell_info[0].output_area.element.on(
        'cleared',
        { fig: fig },
        fig._remove_fig_handler
    );
};

mpl.figure.prototype.handle_close = function (fig, msg) {
    var width = fig.canvas.width / fig.ratio;
    fig.cell_info[0].output_area.element.off(
        'cleared',
        fig._remove_fig_handler
    );
    fig.resizeObserverInstance.unobserve(fig.canvas_div);

    // Update the output cell to use the data from the current canvas.
    fig.push_to_output();
    var dataURL = fig.canvas.toDataURL();
    // Re-enable the keyboard manager in IPython - without this line, in FF,
    // the notebook keyboard shortcuts fail.
    IPython.keyboard_manager.enable();
    fig.parent_element.innerHTML =
        '<img src="' + dataURL + '" width="' + width + '">';
    fig.close_ws(fig, msg);
};

mpl.figure.prototype.close_ws = function (fig, msg) {
    fig.send_message('closing', msg);
    // fig.ws.close()
};

mpl.figure.prototype.push_to_output = function (_remove_interactive) {
    // Turn the data on the canvas into data in the output cell.
    var width = this.canvas.width / this.ratio;
    var dataURL = this.canvas.toDataURL();
    this.cell_info[1]['text/html'] =
        '<img src="' + dataURL + '" width="' + width + '">';
};

mpl.figure.prototype.updated_canvas_event = function () {
    // Tell IPython that the notebook contents must change.
    IPython.notebook.set_dirty(true);
    this.send_message('ack', {});
    var fig = this;
    // Wait a second, then push the new image to the DOM so
    // that it is saved nicely (might be nice to debounce this).
    setTimeout(function () {
        fig.push_to_output();
    }, 1000);
};

mpl.figure.prototype._init_toolbar = function () {
    var fig = this;

    var toolbar = document.createElement('div');
    toolbar.classList = 'btn-toolbar';
    this.root.appendChild(toolbar);

    function on_click_closure(name) {
        return function (_event) {
            return fig.toolbar_button_onclick(name);
        };
    }

    function on_mouseover_closure(tooltip) {
        return function (event) {
            if (!event.currentTarget.disabled) {
                return fig.toolbar_button_onmouseover(tooltip);
            }
        };
    }

    fig.buttons = {};
    var buttonGroup = document.createElement('div');
    buttonGroup.classList = 'btn-group';
    var button;
    for (var toolbar_ind in mpl.toolbar_items) {
        var name = mpl.toolbar_items[toolbar_ind][0];
        var tooltip = mpl.toolbar_items[toolbar_ind][1];
        var image = mpl.toolbar_items[toolbar_ind][2];
        var method_name = mpl.toolbar_items[toolbar_ind][3];

        if (!name) {
            /* Instead of a spacer, we start a new button group. */
            if (buttonGroup.hasChildNodes()) {
                toolbar.appendChild(buttonGroup);
            }
            buttonGroup = document.createElement('div');
            buttonGroup.classList = 'btn-group';
            continue;
        }

        button = fig.buttons[name] = document.createElement('button');
        button.classList = 'btn btn-default';
        button.href = '#';
        button.title = name;
        button.innerHTML = '<i class="fa ' + image + ' fa-lg"></i>';
        button.addEventListener('click', on_click_closure(method_name));
        button.addEventListener('mouseover', on_mouseover_closure(tooltip));
        buttonGroup.appendChild(button);
    }

    if (buttonGroup.hasChildNodes()) {
        toolbar.appendChild(buttonGroup);
    }

    // Add the status bar.
    var status_bar = document.createElement('span');
    status_bar.classList = 'mpl-message pull-right';
    toolbar.appendChild(status_bar);
    this.message = status_bar;

    // Add the close button to the window.
    var buttongrp = document.createElement('div');
    buttongrp.classList = 'btn-group inline pull-right';
    button = document.createElement('button');
    button.classList = 'btn btn-mini btn-primary';
    button.href = '#';
    button.title = 'Stop Interaction';
    button.innerHTML = '<i class="fa fa-power-off icon-remove icon-large"></i>';
    button.addEventListener('click', function (_evt) {
        fig.handle_close(fig, {});
    });
    button.addEventListener(
        'mouseover',
        on_mouseover_closure('Stop Interaction')
    );
    buttongrp.appendChild(button);
    var titlebar = this.root.querySelector('.ui-dialog-titlebar');
    titlebar.insertBefore(buttongrp, titlebar.firstChild);
};

mpl.figure.prototype._remove_fig_handler = function (event) {
    var fig = event.data.fig;
    if (event.target !== this) {
        // Ignore bubbled events from children.
        return;
    }
    fig.close_ws(fig, {});
};

mpl.figure.prototype._root_extra_style = function (el) {
    el.style.boxSizing = 'content-box'; // override notebook setting of border-box.
};

mpl.figure.prototype._canvas_extra_style = function (el) {
    // this is important to make the div 'focusable
    el.setAttribute('tabindex', 0);
    // reach out to IPython and tell the keyboard manager to turn it's self
    // off when our div gets focus

    // location in version 3
    if (IPython.notebook.keyboard_manager) {
        IPython.notebook.keyboard_manager.register_events(el);
    } else {
        // location in version 2
        IPython.keyboard_manager.register_events(el);
    }
};

mpl.figure.prototype._key_event_extra = function (event, _name) {
    // Check for shift+enter
    if (event.shiftKey && event.which === 13) {
        this.canvas_div.blur();
        // select the cell after this one
        var index = IPython.notebook.find_cell_index(this.cell_info[0]);
        IPython.notebook.select(index + 1);
    }
};

mpl.figure.prototype.handle_save = function (fig, _msg) {
    fig.ondownload(fig, null);
};

mpl.find_output_cell = function (html_output) {
    // Return the cell and output element which can be found *uniquely* in the notebook.
    // Note - this is a bit hacky, but it is done because the "notebook_saving.Notebook"
    // IPython event is triggered only after the cells have been serialised, which for
    // our purposes (turning an active figure into a static one), is too late.
    var cells = IPython.notebook.get_cells();
    var ncells = cells.length;
    for (var i = 0; i < ncells; i++) {
        var cell = cells[i];
        if (cell.cell_type === 'code') {
            for (var j = 0; j < cell.output_area.outputs.length; j++) {
                var data = cell.output_area.outputs[j];
                if (data.data) {
                    // IPython >= 3 moved mimebundle to data attribute of output
                    data = data.data;
                }
                if (data['text/html'] === html_output) {
                    return [cell, data, j];
                }
            }
        }
    }
};

// Register the function which deals with the matplotlib target/channel.
// The kernel may be null if the page has been refreshed.
if (IPython.notebook.kernel !== null) {
    IPython.notebook.kernel.comm_manager.register_target(
        'matplotlib',
        mpl.mpl_figure_comm
    );
}

</script>
</div>
<div class="cell-output cell-output-display">
<div id="72933110-5c1b-4a27-a080-41504e8decb5"></div>
</div>
<div class="cell-output cell-output-display" data-execution_count="208">
<video width="640" height="640" controls="" autoplay="" loop="">
  <source type="video/mp4" src="data:video/mp4;base64,AAAAIGZ0eXBNNFYgAAACAE00ViBpc29taXNvMmF2YzEAAAAIZnJlZQAAHoRtZGF0AAACrgYF//+q
3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE2NCByMzA5NSBiYWVlNDAwIC0gSC4yNjQvTVBF
Ry00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAyMiAtIGh0dHA6Ly93d3cudmlkZW9sYW4u
b3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTMgZGVibG9jaz0xOjA6MCBhbmFs
eXNlPTB4MzoweDExMyBtZT1oZXggc3VibWU9NyBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVk
X3JlZj0xIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MSA4eDhkY3Q9MSBjcW09MCBk
ZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0tMiB0aHJlYWRzPTMw
IGxvb2thaGVhZF90aHJlYWRzPTUgc2xpY2VkX3RocmVhZHM9MCBucj0wIGRlY2ltYXRlPTEgaW50
ZXJsYWNlZD0wIGJsdXJheV9jb21wYXQ9MCBjb25zdHJhaW5lZF9pbnRyYT0wIGJmcmFtZXM9MyBi
X3B5cmFtaWQ9MiBiX2FkYXB0PTEgYl9iaWFzPTAgZGlyZWN0PTEgd2VpZ2h0Yj0xIG9wZW5fZ29w
PTAgd2VpZ2h0cD0yIGtleWludD0yNTAga2V5aW50X21pbj01IHNjZW5lY3V0PTQwIGludHJhX3Jl
ZnJlc2g9MCByY19sb29rYWhlYWQ9NDAgcmM9Y3JmIG1idHJlZT0xIGNyZj0yMy4wIHFjb21wPTAu
NjAgcXBtaW49MCBxcG1heD02OSBxcHN0ZXA9NCBpcF9yYXRpbz0xLjQwIGFxPTE6MS4wMACAAAAC
hmWIhAAS//73rd+BTcBA7Wu6Vzi0y6uUND1R9pSmeLZIAAADAAADAAADAAAWkNGdDBVukodCQAAA
AwALkAB6gA4AAnYAlAAm3gAdO+OUiuhKHdcAKsrirAAA7Rf8SMj6k5nz7ANA1frvLwJNBVdAAACM
ADhAI1BT4eitfS7Xl3ggSiZcmY+VlKmZ3MrIy5eYNOFuAAgg2c7PiWQ3sWr9h6R0Rn9rgTT38S7L
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
AExhdmY2MC4zLjEwMA==
">
  Your browser does not support the video tag.
</video>
</div>
</div>
<p>As expected, this one looks easy enough. Next time, we would like to make it a little more difficult. The default maze, which is generated completely at random, is very slow, so let’s make our own maze. The maze samples the start and the goal from 3 different locations with the same probability, and solves a total of 9 combinations. Let’s try to train the maze with 800,000 steps, which is 10 times as many as the default maze.</p>
<div class="cell" data-tags="[]" data-execution_count="209">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MedDifficultyGenerator(Generator):</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    WALLS <span class="op">=</span> [</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>],</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>],</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>],</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>],</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>],</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>],</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(num_rows<span class="op">=</span><span class="dv">10</span>, num_cols<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, key: chex.PRNGKey) <span class="op">-&gt;</span> State:</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>        key, config_key <span class="op">=</span> jax.random.split(key)</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        walls <span class="op">=</span> jnp.array(<span class="va">self</span>.WALLS).astype(<span class="bu">bool</span>)</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>        agent_cfg, target_cfg <span class="op">=</span> jax.random.randint(config_key, (<span class="dv">2</span>,), <span class="dv">0</span>, <span class="dv">2</span>)</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>        agent_position <span class="op">=</span> jax.lax.switch(</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>            agent_cfg,</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>            [</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span>: Position(row<span class="op">=</span><span class="dv">0</span>, col<span class="op">=</span><span class="dv">0</span>),</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span>: Position(row<span class="op">=</span><span class="dv">9</span>, col<span class="op">=</span><span class="dv">0</span>),</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span>: Position(row<span class="op">=</span><span class="dv">0</span>, col<span class="op">=</span><span class="dv">9</span>),</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>        target_position <span class="op">=</span> jax.lax.switch(</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>            target_cfg,</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>            [</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span>: Position(row<span class="op">=</span><span class="dv">3</span>, col<span class="op">=</span><span class="dv">9</span>),</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span>: Position(row<span class="op">=</span><span class="dv">7</span>, col<span class="op">=</span><span class="dv">8</span>),</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span>: Position(row<span class="op">=</span><span class="dv">7</span>, col<span class="op">=</span><span class="dv">0</span>),</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Build the state.</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> State(</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>            agent_position<span class="op">=</span>agent_position,</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>            target_position<span class="op">=</span>target_position,</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>            walls<span class="op">=</span>walls,</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>            action_mask<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>            key<span class="op">=</span>key,</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>            step_count<span class="op">=</span>jnp.array(<span class="dv">0</span>, jnp.int32),</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-tags="[]" data-execution_count="210">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>started <span class="op">=</span> datetime.datetime.now()</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>key, training_key <span class="op">=</span> jax.random.split(key)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>trained_net <span class="op">=</span> run_training(</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    training_key,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    n_total_steps<span class="op">=</span><span class="dv">16</span> <span class="op">*</span> <span class="dv">512</span> <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    generator<span class="op">=</span>MedDifficultyGenerator(),</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>elapsed <span class="op">=</span> datetime.datetime.now() <span class="op">-</span> started</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Elapsed time: </span><span class="sc">{</span>elapsed<span class="sc">.</span>total_seconds()<span class="sc">:.2}</span><span class="ss">s"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Mean episodic return: 0.2812202097235462
Mean episodic return: 0.4077407740774077
Mean episodic return: 0.5992010652463382
Mean episodic return: 0.7285136501516684
Mean episodic return: 0.75
Mean episodic return: 0.8620564808110065
Mean episodic return: 0.9868290258449304
Mean episodic return: 0.9977788746298124
Mean episodic return: 0.9970540974825924
Elapsed time: 1.2e+01s</code></pre>
</div>
</div>
<div class="cell" data-tags="[]" data-execution_count="212">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>env <span class="op">=</span> AutoResetWrapper(jumanji.make(<span class="st">"Maze-v0"</span>, generator<span class="op">=</span>MedDifficultyGenerator()))</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>key, eval_key <span class="op">=</span> jax.random.split(key)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>states <span class="op">=</span> visualization_rollout(eval_key, trained_net, env, <span class="dv">100</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>anim <span class="op">=</span> env.animate(states)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>HTML(anim.to_html5_video().replace(<span class="st">'="1000"'</span>, <span class="st">'="640"'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/javascript">
/* Put everything inside the global mpl namespace */
/* global mpl */
window.mpl = {};

mpl.get_websocket_type = function () {
    if (typeof WebSocket !== 'undefined') {
        return WebSocket;
    } else if (typeof MozWebSocket !== 'undefined') {
        return MozWebSocket;
    } else {
        alert(
            'Your browser does not have WebSocket support. ' +
                'Please try Chrome, Safari or Firefox ≥ 6. ' +
                'Firefox 4 and 5 are also supported but you ' +
                'have to enable WebSockets in about:config.'
        );
    }
};

mpl.figure = function (figure_id, websocket, ondownload, parent_element) {
    this.id = figure_id;

    this.ws = websocket;

    this.supports_binary = this.ws.binaryType !== undefined;

    if (!this.supports_binary) {
        var warnings = document.getElementById('mpl-warnings');
        if (warnings) {
            warnings.style.display = 'block';
            warnings.textContent =
                'This browser does not support binary websocket messages. ' +
                'Performance may be slow.';
        }
    }

    this.imageObj = new Image();

    this.context = undefined;
    this.message = undefined;
    this.canvas = undefined;
    this.rubberband_canvas = undefined;
    this.rubberband_context = undefined;
    this.format_dropdown = undefined;

    this.image_mode = 'full';

    this.root = document.createElement('div');
    this.root.setAttribute('style', 'display: inline-block');
    this._root_extra_style(this.root);

    parent_element.appendChild(this.root);

    this._init_header(this);
    this._init_canvas(this);
    this._init_toolbar(this);

    var fig = this;

    this.waiting = false;

    this.ws.onopen = function () {
        fig.send_message('supports_binary', { value: fig.supports_binary });
        fig.send_message('send_image_mode', {});
        if (fig.ratio !== 1) {
            fig.send_message('set_device_pixel_ratio', {
                device_pixel_ratio: fig.ratio,
            });
        }
        fig.send_message('refresh', {});
    };

    this.imageObj.onload = function () {
        if (fig.image_mode === 'full') {
            // Full images could contain transparency (where diff images
            // almost always do), so we need to clear the canvas so that
            // there is no ghosting.
            fig.context.clearRect(0, 0, fig.canvas.width, fig.canvas.height);
        }
        fig.context.drawImage(fig.imageObj, 0, 0);
    };

    this.imageObj.onunload = function () {
        fig.ws.close();
    };

    this.ws.onmessage = this._make_on_message_function(this);

    this.ondownload = ondownload;
};

mpl.figure.prototype._init_header = function () {
    var titlebar = document.createElement('div');
    titlebar.classList =
        'ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix';
    var titletext = document.createElement('div');
    titletext.classList = 'ui-dialog-title';
    titletext.setAttribute(
        'style',
        'width: 100%; text-align: center; padding: 3px;'
    );
    titlebar.appendChild(titletext);
    this.root.appendChild(titlebar);
    this.header = titletext;
};

mpl.figure.prototype._canvas_extra_style = function (_canvas_div) {};

mpl.figure.prototype._root_extra_style = function (_canvas_div) {};

mpl.figure.prototype._init_canvas = function () {
    var fig = this;

    var canvas_div = (this.canvas_div = document.createElement('div'));
    canvas_div.setAttribute('tabindex', '0');
    canvas_div.setAttribute(
        'style',
        'border: 1px solid #ddd;' +
            'box-sizing: content-box;' +
            'clear: both;' +
            'min-height: 1px;' +
            'min-width: 1px;' +
            'outline: 0;' +
            'overflow: hidden;' +
            'position: relative;' +
            'resize: both;' +
            'z-index: 2;'
    );

    function on_keyboard_event_closure(name) {
        return function (event) {
            return fig.key_event(event, name);
        };
    }

    canvas_div.addEventListener(
        'keydown',
        on_keyboard_event_closure('key_press')
    );
    canvas_div.addEventListener(
        'keyup',
        on_keyboard_event_closure('key_release')
    );

    this._canvas_extra_style(canvas_div);
    this.root.appendChild(canvas_div);

    var canvas = (this.canvas = document.createElement('canvas'));
    canvas.classList.add('mpl-canvas');
    canvas.setAttribute(
        'style',
        'box-sizing: content-box;' +
            'pointer-events: none;' +
            'position: relative;' +
            'z-index: 0;'
    );

    this.context = canvas.getContext('2d');

    var backingStore =
        this.context.backingStorePixelRatio ||
        this.context.webkitBackingStorePixelRatio ||
        this.context.mozBackingStorePixelRatio ||
        this.context.msBackingStorePixelRatio ||
        this.context.oBackingStorePixelRatio ||
        this.context.backingStorePixelRatio ||
        1;

    this.ratio = (window.devicePixelRatio || 1) / backingStore;

    var rubberband_canvas = (this.rubberband_canvas = document.createElement(
        'canvas'
    ));
    rubberband_canvas.setAttribute(
        'style',
        'box-sizing: content-box;' +
            'left: 0;' +
            'pointer-events: none;' +
            'position: absolute;' +
            'top: 0;' +
            'z-index: 1;'
    );

    // Apply a ponyfill if ResizeObserver is not implemented by browser.
    if (this.ResizeObserver === undefined) {
        if (window.ResizeObserver !== undefined) {
            this.ResizeObserver = window.ResizeObserver;
        } else {
            var obs = _JSXTOOLS_RESIZE_OBSERVER({});
            this.ResizeObserver = obs.ResizeObserver;
        }
    }

    this.resizeObserverInstance = new this.ResizeObserver(function (entries) {
        var nentries = entries.length;
        for (var i = 0; i < nentries; i++) {
            var entry = entries[i];
            var width, height;
            if (entry.contentBoxSize) {
                if (entry.contentBoxSize instanceof Array) {
                    // Chrome 84 implements new version of spec.
                    width = entry.contentBoxSize[0].inlineSize;
                    height = entry.contentBoxSize[0].blockSize;
                } else {
                    // Firefox implements old version of spec.
                    width = entry.contentBoxSize.inlineSize;
                    height = entry.contentBoxSize.blockSize;
                }
            } else {
                // Chrome <84 implements even older version of spec.
                width = entry.contentRect.width;
                height = entry.contentRect.height;
            }

            // Keep the size of the canvas and rubber band canvas in sync with
            // the canvas container.
            if (entry.devicePixelContentBoxSize) {
                // Chrome 84 implements new version of spec.
                canvas.setAttribute(
                    'width',
                    entry.devicePixelContentBoxSize[0].inlineSize
                );
                canvas.setAttribute(
                    'height',
                    entry.devicePixelContentBoxSize[0].blockSize
                );
            } else {
                canvas.setAttribute('width', width * fig.ratio);
                canvas.setAttribute('height', height * fig.ratio);
            }
            /* This rescales the canvas back to display pixels, so that it
             * appears correct on HiDPI screens. */
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';

            rubberband_canvas.setAttribute('width', width);
            rubberband_canvas.setAttribute('height', height);

            // And update the size in Python. We ignore the initial 0/0 size
            // that occurs as the element is placed into the DOM, which should
            // otherwise not happen due to the minimum size styling.
            if (fig.ws.readyState == 1 && width != 0 && height != 0) {
                fig.request_resize(width, height);
            }
        }
    });
    this.resizeObserverInstance.observe(canvas_div);

    function on_mouse_event_closure(name) {
        /* User Agent sniffing is bad, but WebKit is busted:
         * https://bugs.webkit.org/show_bug.cgi?id=144526
         * https://bugs.webkit.org/show_bug.cgi?id=181818
         * The worst that happens here is that they get an extra browser
         * selection when dragging, if this check fails to catch them.
         */
        var UA = navigator.userAgent;
        var isWebKit = /AppleWebKit/.test(UA) && !/Chrome/.test(UA);
        if(isWebKit) {
            return function (event) {
                /* This prevents the web browser from automatically changing to
                 * the text insertion cursor when the button is pressed. We
                 * want to control all of the cursor setting manually through
                 * the 'cursor' event from matplotlib */
                event.preventDefault()
                return fig.mouse_event(event, name);
            };
        } else {
            return function (event) {
                return fig.mouse_event(event, name);
            };
        }
    }

    canvas_div.addEventListener(
        'mousedown',
        on_mouse_event_closure('button_press')
    );
    canvas_div.addEventListener(
        'mouseup',
        on_mouse_event_closure('button_release')
    );
    canvas_div.addEventListener(
        'dblclick',
        on_mouse_event_closure('dblclick')
    );
    // Throttle sequential mouse events to 1 every 20ms.
    canvas_div.addEventListener(
        'mousemove',
        on_mouse_event_closure('motion_notify')
    );

    canvas_div.addEventListener(
        'mouseenter',
        on_mouse_event_closure('figure_enter')
    );
    canvas_div.addEventListener(
        'mouseleave',
        on_mouse_event_closure('figure_leave')
    );

    canvas_div.addEventListener('wheel', function (event) {
        if (event.deltaY < 0) {
            event.step = 1;
        } else {
            event.step = -1;
        }
        on_mouse_event_closure('scroll')(event);
    });

    canvas_div.appendChild(canvas);
    canvas_div.appendChild(rubberband_canvas);

    this.rubberband_context = rubberband_canvas.getContext('2d');
    this.rubberband_context.strokeStyle = '#000000';

    this._resize_canvas = function (width, height, forward) {
        if (forward) {
            canvas_div.style.width = width + 'px';
            canvas_div.style.height = height + 'px';
        }
    };

    // Disable right mouse context menu.
    canvas_div.addEventListener('contextmenu', function (_e) {
        event.preventDefault();
        return false;
    });

    function set_focus() {
        canvas.focus();
        canvas_div.focus();
    }

    window.setTimeout(set_focus, 100);
};

mpl.figure.prototype._init_toolbar = function () {
    var fig = this;

    var toolbar = document.createElement('div');
    toolbar.classList = 'mpl-toolbar';
    this.root.appendChild(toolbar);

    function on_click_closure(name) {
        return function (_event) {
            return fig.toolbar_button_onclick(name);
        };
    }

    function on_mouseover_closure(tooltip) {
        return function (event) {
            if (!event.currentTarget.disabled) {
                return fig.toolbar_button_onmouseover(tooltip);
            }
        };
    }

    fig.buttons = {};
    var buttonGroup = document.createElement('div');
    buttonGroup.classList = 'mpl-button-group';
    for (var toolbar_ind in mpl.toolbar_items) {
        var name = mpl.toolbar_items[toolbar_ind][0];
        var tooltip = mpl.toolbar_items[toolbar_ind][1];
        var image = mpl.toolbar_items[toolbar_ind][2];
        var method_name = mpl.toolbar_items[toolbar_ind][3];

        if (!name) {
            /* Instead of a spacer, we start a new button group. */
            if (buttonGroup.hasChildNodes()) {
                toolbar.appendChild(buttonGroup);
            }
            buttonGroup = document.createElement('div');
            buttonGroup.classList = 'mpl-button-group';
            continue;
        }

        var button = (fig.buttons[name] = document.createElement('button'));
        button.classList = 'mpl-widget';
        button.setAttribute('role', 'button');
        button.setAttribute('aria-disabled', 'false');
        button.addEventListener('click', on_click_closure(method_name));
        button.addEventListener('mouseover', on_mouseover_closure(tooltip));

        var icon_img = document.createElement('img');
        icon_img.src = '_images/' + image + '.png';
        icon_img.srcset = '_images/' + image + '_large.png 2x';
        icon_img.alt = tooltip;
        button.appendChild(icon_img);

        buttonGroup.appendChild(button);
    }

    if (buttonGroup.hasChildNodes()) {
        toolbar.appendChild(buttonGroup);
    }

    var fmt_picker = document.createElement('select');
    fmt_picker.classList = 'mpl-widget';
    toolbar.appendChild(fmt_picker);
    this.format_dropdown = fmt_picker;

    for (var ind in mpl.extensions) {
        var fmt = mpl.extensions[ind];
        var option = document.createElement('option');
        option.selected = fmt === mpl.default_extension;
        option.innerHTML = fmt;
        fmt_picker.appendChild(option);
    }

    var status_bar = document.createElement('span');
    status_bar.classList = 'mpl-message';
    toolbar.appendChild(status_bar);
    this.message = status_bar;
};

mpl.figure.prototype.request_resize = function (x_pixels, y_pixels) {
    // Request matplotlib to resize the figure. Matplotlib will then trigger a resize in the client,
    // which will in turn request a refresh of the image.
    this.send_message('resize', { width: x_pixels, height: y_pixels });
};

mpl.figure.prototype.send_message = function (type, properties) {
    properties['type'] = type;
    properties['figure_id'] = this.id;
    this.ws.send(JSON.stringify(properties));
};

mpl.figure.prototype.send_draw_message = function () {
    if (!this.waiting) {
        this.waiting = true;
        this.ws.send(JSON.stringify({ type: 'draw', figure_id: this.id }));
    }
};

mpl.figure.prototype.handle_save = function (fig, _msg) {
    var format_dropdown = fig.format_dropdown;
    var format = format_dropdown.options[format_dropdown.selectedIndex].value;
    fig.ondownload(fig, format);
};

mpl.figure.prototype.handle_resize = function (fig, msg) {
    var size = msg['size'];
    if (size[0] !== fig.canvas.width || size[1] !== fig.canvas.height) {
        fig._resize_canvas(size[0], size[1], msg['forward']);
        fig.send_message('refresh', {});
    }
};

mpl.figure.prototype.handle_rubberband = function (fig, msg) {
    var x0 = msg['x0'] / fig.ratio;
    var y0 = (fig.canvas.height - msg['y0']) / fig.ratio;
    var x1 = msg['x1'] / fig.ratio;
    var y1 = (fig.canvas.height - msg['y1']) / fig.ratio;
    x0 = Math.floor(x0) + 0.5;
    y0 = Math.floor(y0) + 0.5;
    x1 = Math.floor(x1) + 0.5;
    y1 = Math.floor(y1) + 0.5;
    var min_x = Math.min(x0, x1);
    var min_y = Math.min(y0, y1);
    var width = Math.abs(x1 - x0);
    var height = Math.abs(y1 - y0);

    fig.rubberband_context.clearRect(
        0,
        0,
        fig.canvas.width / fig.ratio,
        fig.canvas.height / fig.ratio
    );

    fig.rubberband_context.strokeRect(min_x, min_y, width, height);
};

mpl.figure.prototype.handle_figure_label = function (fig, msg) {
    // Updates the figure title.
    fig.header.textContent = msg['label'];
};

mpl.figure.prototype.handle_cursor = function (fig, msg) {
    fig.canvas_div.style.cursor = msg['cursor'];
};

mpl.figure.prototype.handle_message = function (fig, msg) {
    fig.message.textContent = msg['message'];
};

mpl.figure.prototype.handle_draw = function (fig, _msg) {
    // Request the server to send over a new figure.
    fig.send_draw_message();
};

mpl.figure.prototype.handle_image_mode = function (fig, msg) {
    fig.image_mode = msg['mode'];
};

mpl.figure.prototype.handle_history_buttons = function (fig, msg) {
    for (var key in msg) {
        if (!(key in fig.buttons)) {
            continue;
        }
        fig.buttons[key].disabled = !msg[key];
        fig.buttons[key].setAttribute('aria-disabled', !msg[key]);
    }
};

mpl.figure.prototype.handle_navigate_mode = function (fig, msg) {
    if (msg['mode'] === 'PAN') {
        fig.buttons['Pan'].classList.add('active');
        fig.buttons['Zoom'].classList.remove('active');
    } else if (msg['mode'] === 'ZOOM') {
        fig.buttons['Pan'].classList.remove('active');
        fig.buttons['Zoom'].classList.add('active');
    } else {
        fig.buttons['Pan'].classList.remove('active');
        fig.buttons['Zoom'].classList.remove('active');
    }
};

mpl.figure.prototype.updated_canvas_event = function () {
    // Called whenever the canvas gets updated.
    this.send_message('ack', {});
};

// A function to construct a web socket function for onmessage handling.
// Called in the figure constructor.
mpl.figure.prototype._make_on_message_function = function (fig) {
    return function socket_on_message(evt) {
        if (evt.data instanceof Blob) {
            var img = evt.data;
            if (img.type !== 'image/png') {
                /* FIXME: We get "Resource interpreted as Image but
                 * transferred with MIME type text/plain:" errors on
                 * Chrome.  But how to set the MIME type?  It doesn't seem
                 * to be part of the websocket stream */
                img.type = 'image/png';
            }

            /* Free the memory for the previous frames */
            if (fig.imageObj.src) {
                (window.URL || window.webkitURL).revokeObjectURL(
                    fig.imageObj.src
                );
            }

            fig.imageObj.src = (window.URL || window.webkitURL).createObjectURL(
                img
            );
            fig.updated_canvas_event();
            fig.waiting = false;
            return;
        } else if (
            typeof evt.data === 'string' &&
            evt.data.slice(0, 21) === 'data:image/png;base64'
        ) {
            fig.imageObj.src = evt.data;
            fig.updated_canvas_event();
            fig.waiting = false;
            return;
        }

        var msg = JSON.parse(evt.data);
        var msg_type = msg['type'];

        // Call the  "handle_{type}" callback, which takes
        // the figure and JSON message as its only arguments.
        try {
            var callback = fig['handle_' + msg_type];
        } catch (e) {
            console.log(
                "No handler for the '" + msg_type + "' message type: ",
                msg
            );
            return;
        }

        if (callback) {
            try {
                // console.log("Handling '" + msg_type + "' message: ", msg);
                callback(fig, msg);
            } catch (e) {
                console.log(
                    "Exception inside the 'handler_" + msg_type + "' callback:",
                    e,
                    e.stack,
                    msg
                );
            }
        }
    };
};

function getModifiers(event) {
    var mods = [];
    if (event.ctrlKey) {
        mods.push('ctrl');
    }
    if (event.altKey) {
        mods.push('alt');
    }
    if (event.shiftKey) {
        mods.push('shift');
    }
    if (event.metaKey) {
        mods.push('meta');
    }
    return mods;
}

/*
 * return a copy of an object with only non-object keys
 * we need this to avoid circular references
 * https://stackoverflow.com/a/24161582/3208463
 */
function simpleKeys(original) {
    return Object.keys(original).reduce(function (obj, key) {
        if (typeof original[key] !== 'object') {
            obj[key] = original[key];
        }
        return obj;
    }, {});
}

mpl.figure.prototype.mouse_event = function (event, name) {
    if (name === 'button_press') {
        this.canvas.focus();
        this.canvas_div.focus();
    }

    // from https://stackoverflow.com/q/1114465
    var boundingRect = this.canvas.getBoundingClientRect();
    var x = (event.clientX - boundingRect.left) * this.ratio;
    var y = (event.clientY - boundingRect.top) * this.ratio;

    this.send_message(name, {
        x: x,
        y: y,
        button: event.button,
        step: event.step,
        modifiers: getModifiers(event),
        guiEvent: simpleKeys(event),
    });

    return false;
};

mpl.figure.prototype._key_event_extra = function (_event, _name) {
    // Handle any extra behaviour associated with a key event
};

mpl.figure.prototype.key_event = function (event, name) {
    // Prevent repeat events
    if (name === 'key_press') {
        if (event.key === this._key) {
            return;
        } else {
            this._key = event.key;
        }
    }
    if (name === 'key_release') {
        this._key = null;
    }

    var value = '';
    if (event.ctrlKey && event.key !== 'Control') {
        value += 'ctrl+';
    }
    else if (event.altKey && event.key !== 'Alt') {
        value += 'alt+';
    }
    else if (event.shiftKey && event.key !== 'Shift') {
        value += 'shift+';
    }

    value += 'k' + event.key;

    this._key_event_extra(event, name);

    this.send_message(name, { key: value, guiEvent: simpleKeys(event) });
    return false;
};

mpl.figure.prototype.toolbar_button_onclick = function (name) {
    if (name === 'download') {
        this.handle_save(this, null);
    } else {
        this.send_message('toolbar_button', { name: name });
    }
};

mpl.figure.prototype.toolbar_button_onmouseover = function (tooltip) {
    this.message.textContent = tooltip;
};

///////////////// REMAINING CONTENT GENERATED BY embed_js.py /////////////////
// prettier-ignore
var _JSXTOOLS_RESIZE_OBSERVER=function(A){var t,i=new WeakMap,n=new WeakMap,a=new WeakMap,r=new WeakMap,o=new Set;function s(e){if(!(this instanceof s))throw new TypeError("Constructor requires 'new' operator");i.set(this,e)}function h(){throw new TypeError("Function is not a constructor")}function c(e,t,i,n){e=0 in arguments?Number(arguments[0]):0,t=1 in arguments?Number(arguments[1]):0,i=2 in arguments?Number(arguments[2]):0,n=3 in arguments?Number(arguments[3]):0,this.right=(this.x=this.left=e)+(this.width=i),this.bottom=(this.y=this.top=t)+(this.height=n),Object.freeze(this)}function d(){t=requestAnimationFrame(d);var s=new WeakMap,p=new Set;o.forEach((function(t){r.get(t).forEach((function(i){var r=t instanceof window.SVGElement,o=a.get(t),d=r?0:parseFloat(o.paddingTop),f=r?0:parseFloat(o.paddingRight),l=r?0:parseFloat(o.paddingBottom),u=r?0:parseFloat(o.paddingLeft),g=r?0:parseFloat(o.borderTopWidth),m=r?0:parseFloat(o.borderRightWidth),w=r?0:parseFloat(o.borderBottomWidth),b=u+f,F=d+l,v=(r?0:parseFloat(o.borderLeftWidth))+m,W=g+w,y=r?0:t.offsetHeight-W-t.clientHeight,E=r?0:t.offsetWidth-v-t.clientWidth,R=b+v,z=F+W,M=r?t.width:parseFloat(o.width)-R-E,O=r?t.height:parseFloat(o.height)-z-y;if(n.has(t)){var k=n.get(t);if(k[0]===M&&k[1]===O)return}n.set(t,[M,O]);var S=Object.create(h.prototype);S.target=t,S.contentRect=new c(u,d,M,O),s.has(i)||(s.set(i,[]),p.add(i)),s.get(i).push(S)}))})),p.forEach((function(e){i.get(e).call(e,s.get(e),e)}))}return s.prototype.observe=function(i){if(i instanceof window.Element){r.has(i)||(r.set(i,new Set),o.add(i),a.set(i,window.getComputedStyle(i)));var n=r.get(i);n.has(this)||n.add(this),cancelAnimationFrame(t),t=requestAnimationFrame(d)}},s.prototype.unobserve=function(i){if(i instanceof window.Element&&r.has(i)){var n=r.get(i);n.has(this)&&(n.delete(this),n.size||(r.delete(i),o.delete(i))),n.size||r.delete(i),o.size||cancelAnimationFrame(t)}},A.DOMRectReadOnly=c,A.ResizeObserver=s,A.ResizeObserverEntry=h,A}; // eslint-disable-line
mpl.toolbar_items = [["Home", "Reset original view", "fa fa-home", "home"], ["Back", "Back to previous view", "fa fa-arrow-left", "back"], ["Forward", "Forward to next view", "fa fa-arrow-right", "forward"], ["", "", "", ""], ["Pan", "Left button pans, Right button zooms\nx/y fixes axis, CTRL fixes aspect", "fa fa-arrows", "pan"], ["Zoom", "Zoom to rectangle\nx/y fixes axis", "fa fa-square-o", "zoom"], ["", "", "", ""], ["Download", "Download plot", "fa fa-floppy-o", "download"]];

mpl.extensions = ["eps", "jpeg", "pgf", "pdf", "png", "ps", "raw", "svg", "tif", "webp"];

mpl.default_extension = "png";/* global mpl */

var comm_websocket_adapter = function (comm) {
    // Create a "websocket"-like object which calls the given IPython comm
    // object with the appropriate methods. Currently this is a non binary
    // socket, so there is still some room for performance tuning.
    var ws = {};

    ws.binaryType = comm.kernel.ws.binaryType;
    ws.readyState = comm.kernel.ws.readyState;
    function updateReadyState(_event) {
        if (comm.kernel.ws) {
            ws.readyState = comm.kernel.ws.readyState;
        } else {
            ws.readyState = 3; // Closed state.
        }
    }
    comm.kernel.ws.addEventListener('open', updateReadyState);
    comm.kernel.ws.addEventListener('close', updateReadyState);
    comm.kernel.ws.addEventListener('error', updateReadyState);

    ws.close = function () {
        comm.close();
    };
    ws.send = function (m) {
        //console.log('sending', m);
        comm.send(m);
    };
    // Register the callback with on_msg.
    comm.on_msg(function (msg) {
        //console.log('receiving', msg['content']['data'], msg);
        var data = msg['content']['data'];
        if (data['blob'] !== undefined) {
            data = {
                data: new Blob(msg['buffers'], { type: data['blob'] }),
            };
        }
        // Pass the mpl event to the overridden (by mpl) onmessage function.
        ws.onmessage(data);
    });
    return ws;
};

mpl.mpl_figure_comm = function (comm, msg) {
    // This is the function which gets called when the mpl process
    // starts-up an IPython Comm through the "matplotlib" channel.

    var id = msg.content.data.id;
    // Get hold of the div created by the display call when the Comm
    // socket was opened in Python.
    var element = document.getElementById(id);
    var ws_proxy = comm_websocket_adapter(comm);

    function ondownload(figure, _format) {
        window.open(figure.canvas.toDataURL());
    }

    var fig = new mpl.figure(id, ws_proxy, ondownload, element);

    // Call onopen now - mpl needs it, as it is assuming we've passed it a real
    // web socket which is closed, not our websocket->open comm proxy.
    ws_proxy.onopen();

    fig.parent_element = element;
    fig.cell_info = mpl.find_output_cell("<div id='" + id + "'></div>");
    if (!fig.cell_info) {
        console.error('Failed to find cell for figure', id, fig);
        return;
    }
    fig.cell_info[0].output_area.element.on(
        'cleared',
        { fig: fig },
        fig._remove_fig_handler
    );
};

mpl.figure.prototype.handle_close = function (fig, msg) {
    var width = fig.canvas.width / fig.ratio;
    fig.cell_info[0].output_area.element.off(
        'cleared',
        fig._remove_fig_handler
    );
    fig.resizeObserverInstance.unobserve(fig.canvas_div);

    // Update the output cell to use the data from the current canvas.
    fig.push_to_output();
    var dataURL = fig.canvas.toDataURL();
    // Re-enable the keyboard manager in IPython - without this line, in FF,
    // the notebook keyboard shortcuts fail.
    IPython.keyboard_manager.enable();
    fig.parent_element.innerHTML =
        '<img src="' + dataURL + '" width="' + width + '">';
    fig.close_ws(fig, msg);
};

mpl.figure.prototype.close_ws = function (fig, msg) {
    fig.send_message('closing', msg);
    // fig.ws.close()
};

mpl.figure.prototype.push_to_output = function (_remove_interactive) {
    // Turn the data on the canvas into data in the output cell.
    var width = this.canvas.width / this.ratio;
    var dataURL = this.canvas.toDataURL();
    this.cell_info[1]['text/html'] =
        '<img src="' + dataURL + '" width="' + width + '">';
};

mpl.figure.prototype.updated_canvas_event = function () {
    // Tell IPython that the notebook contents must change.
    IPython.notebook.set_dirty(true);
    this.send_message('ack', {});
    var fig = this;
    // Wait a second, then push the new image to the DOM so
    // that it is saved nicely (might be nice to debounce this).
    setTimeout(function () {
        fig.push_to_output();
    }, 1000);
};

mpl.figure.prototype._init_toolbar = function () {
    var fig = this;

    var toolbar = document.createElement('div');
    toolbar.classList = 'btn-toolbar';
    this.root.appendChild(toolbar);

    function on_click_closure(name) {
        return function (_event) {
            return fig.toolbar_button_onclick(name);
        };
    }

    function on_mouseover_closure(tooltip) {
        return function (event) {
            if (!event.currentTarget.disabled) {
                return fig.toolbar_button_onmouseover(tooltip);
            }
        };
    }

    fig.buttons = {};
    var buttonGroup = document.createElement('div');
    buttonGroup.classList = 'btn-group';
    var button;
    for (var toolbar_ind in mpl.toolbar_items) {
        var name = mpl.toolbar_items[toolbar_ind][0];
        var tooltip = mpl.toolbar_items[toolbar_ind][1];
        var image = mpl.toolbar_items[toolbar_ind][2];
        var method_name = mpl.toolbar_items[toolbar_ind][3];

        if (!name) {
            /* Instead of a spacer, we start a new button group. */
            if (buttonGroup.hasChildNodes()) {
                toolbar.appendChild(buttonGroup);
            }
            buttonGroup = document.createElement('div');
            buttonGroup.classList = 'btn-group';
            continue;
        }

        button = fig.buttons[name] = document.createElement('button');
        button.classList = 'btn btn-default';
        button.href = '#';
        button.title = name;
        button.innerHTML = '<i class="fa ' + image + ' fa-lg"></i>';
        button.addEventListener('click', on_click_closure(method_name));
        button.addEventListener('mouseover', on_mouseover_closure(tooltip));
        buttonGroup.appendChild(button);
    }

    if (buttonGroup.hasChildNodes()) {
        toolbar.appendChild(buttonGroup);
    }

    // Add the status bar.
    var status_bar = document.createElement('span');
    status_bar.classList = 'mpl-message pull-right';
    toolbar.appendChild(status_bar);
    this.message = status_bar;

    // Add the close button to the window.
    var buttongrp = document.createElement('div');
    buttongrp.classList = 'btn-group inline pull-right';
    button = document.createElement('button');
    button.classList = 'btn btn-mini btn-primary';
    button.href = '#';
    button.title = 'Stop Interaction';
    button.innerHTML = '<i class="fa fa-power-off icon-remove icon-large"></i>';
    button.addEventListener('click', function (_evt) {
        fig.handle_close(fig, {});
    });
    button.addEventListener(
        'mouseover',
        on_mouseover_closure('Stop Interaction')
    );
    buttongrp.appendChild(button);
    var titlebar = this.root.querySelector('.ui-dialog-titlebar');
    titlebar.insertBefore(buttongrp, titlebar.firstChild);
};

mpl.figure.prototype._remove_fig_handler = function (event) {
    var fig = event.data.fig;
    if (event.target !== this) {
        // Ignore bubbled events from children.
        return;
    }
    fig.close_ws(fig, {});
};

mpl.figure.prototype._root_extra_style = function (el) {
    el.style.boxSizing = 'content-box'; // override notebook setting of border-box.
};

mpl.figure.prototype._canvas_extra_style = function (el) {
    // this is important to make the div 'focusable
    el.setAttribute('tabindex', 0);
    // reach out to IPython and tell the keyboard manager to turn it's self
    // off when our div gets focus

    // location in version 3
    if (IPython.notebook.keyboard_manager) {
        IPython.notebook.keyboard_manager.register_events(el);
    } else {
        // location in version 2
        IPython.keyboard_manager.register_events(el);
    }
};

mpl.figure.prototype._key_event_extra = function (event, _name) {
    // Check for shift+enter
    if (event.shiftKey && event.which === 13) {
        this.canvas_div.blur();
        // select the cell after this one
        var index = IPython.notebook.find_cell_index(this.cell_info[0]);
        IPython.notebook.select(index + 1);
    }
};

mpl.figure.prototype.handle_save = function (fig, _msg) {
    fig.ondownload(fig, null);
};

mpl.find_output_cell = function (html_output) {
    // Return the cell and output element which can be found *uniquely* in the notebook.
    // Note - this is a bit hacky, but it is done because the "notebook_saving.Notebook"
    // IPython event is triggered only after the cells have been serialised, which for
    // our purposes (turning an active figure into a static one), is too late.
    var cells = IPython.notebook.get_cells();
    var ncells = cells.length;
    for (var i = 0; i < ncells; i++) {
        var cell = cells[i];
        if (cell.cell_type === 'code') {
            for (var j = 0; j < cell.output_area.outputs.length; j++) {
                var data = cell.output_area.outputs[j];
                if (data.data) {
                    // IPython >= 3 moved mimebundle to data attribute of output
                    data = data.data;
                }
                if (data['text/html'] === html_output) {
                    return [cell, data, j];
                }
            }
        }
    }
};

// Register the function which deals with the matplotlib target/channel.
// The kernel may be null if the page has been refreshed.
if (IPython.notebook.kernel !== null) {
    IPython.notebook.kernel.comm_manager.register_target(
        'matplotlib',
        mpl.mpl_figure_comm
    );
}

</script>
</div>
<div class="cell-output cell-output-display">
<div id="70502988-5f06-4ab7-a035-2a889a85911c"></div>
</div>
<div class="cell-output cell-output-display" data-execution_count="212">
<video width="640" height="640" controls="" autoplay="" loop="">
  <source type="video/mp4" src="data:video/mp4;base64,AAAAIGZ0eXBNNFYgAAACAE00ViBpc29taXNvMmF2YzEAAAAIZnJlZQAAVjxtZGF0AAACrgYF//+q
3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE2NCByMzA5NSBiYWVlNDAwIC0gSC4yNjQvTVBF
Ry00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAyMiAtIGh0dHA6Ly93d3cudmlkZW9sYW4u
b3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTMgZGVibG9jaz0xOjA6MCBhbmFs
eXNlPTB4MzoweDExMyBtZT1oZXggc3VibWU9NyBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVk
X3JlZj0xIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MSA4eDhkY3Q9MSBjcW09MCBk
ZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0tMiB0aHJlYWRzPTMw
IGxvb2thaGVhZF90aHJlYWRzPTUgc2xpY2VkX3RocmVhZHM9MCBucj0wIGRlY2ltYXRlPTEgaW50
ZXJsYWNlZD0wIGJsdXJheV9jb21wYXQ9MCBjb25zdHJhaW5lZF9pbnRyYT0wIGJmcmFtZXM9MyBi
X3B5cmFtaWQ9MiBiX2FkYXB0PTEgYl9iaWFzPTAgZGlyZWN0PTEgd2VpZ2h0Yj0xIG9wZW5fZ29w
PTAgd2VpZ2h0cD0yIGtleWludD0yNTAga2V5aW50X21pbj01IHNjZW5lY3V0PTQwIGludHJhX3Jl
ZnJlc2g9MCByY19sb29rYWhlYWQ9NDAgcmM9Y3JmIG1idHJlZT0xIGNyZj0yMy4wIHFjb21wPTAu
NjAgcXBtaW49MCBxcG1heD02OSBxcHN0ZXA9NCBpcF9yYXRpbz0xLjQwIGFxPTE6MS4wMACAAAAF
rGWIhAAS//73rd+BTcBA7Wu6Vzi0y6uUND1R9pSmeLZIAAADAAADAAADAAAWkNGdDBVukodCQAAA
AwALkAB6gA4AAnYAlAAm3gAdO+OUiuhKHdcAKsrirAAA7Rf8SMj6k5nz7ANA1frvLwJNBVdAAACM
ADhAIweI8krOHo7YTub0s+bIkr2Qnc+CUfzE2DZzs2VifyBw25HZOieKA3EKw7ZTCDdosrKV+DFi
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
EAAAAAABAAAYAAAAAAEAAAgAAAAADgAAEAAAAAABAAAYAAAAAAEAAAgAAAAAAQAAGAAAAAABAAAI
AAAAAAEAABAAAAAAAQAAGAAAAAABAAAIAAAAAAIAABAAAAAAAQAAGAAAAAABAAAIAAAAAAMAABAA
AAAAAQAAGAAAAAABAAAIAAAAAAEAABgAAAAAAQAACAAAAAABAAAYAAAAAAEAAAgAAAAAAQAAEAAA
AAABAAAYAAAAAAEAAAgAAAAAAgAAEAAAAAABAAAYAAAAAAEAAAgAAAAAHwAAEAAAAAABAAAYAAAA
AAEAAAgAAAAAAQAAGAAAAAABAAAIAAAAAAEAABAAAAAAAQAAGAAAAAABAAAIAAAAAAEAABAAAAAA
AQAAGAAAAAABAAAIAAAAAAIAABAAAAAAAQAAGAAAAAABAAAIAAAAAAIAABAAAAAAHHN0c2MAAAAA
AAAAAQAAAAEAAABlAAAAAQAAAahzdHN6AAAAAAAAAAAAAABlAAAIYgAAAH8AAABTAAAA+wAAAQMA
AAEeAAABNAAAAK0AAAEcAAABJAAAAVMAAAFAAAAAlAAAAVwAAAEyAAACCQAAAG8AAABkAAAAaAAA
AGAAAABsAAAAXwAAAFkAAABVAAAA/gAAAQgAAAEUAAABSgAAAKsAAAFFAAAA+gAAAUoAAAEtAAAA
egAAASsAAAESAAAA0wAAAQIAAABbAAAAWgAAAN0AAAEYAAAApgAAAUkAAACqAAABPQAAAO8AAAFZ
AAABLQAAAHoAAAEsAAABEgAAAJkAAAEEAAAAdAAAAIwAAABUAAAAVQAAAFQAAAB1AAAAVAAAAIEA
AACmAAAAUAAAAFwAAABSAAAAYwAAAFIAAACWAAAAUQAAAFYAAAC9AAAAWwAAAF4AAABfAAAAUgAA
AFUAAABwAAAAUQAAAMAAAABVAAAAUgAAAKIAAAD/AAABEwAAATQAAADiAAABIQAAAQAAAAEKAAAB
LAAAAQQAAAFEAAABKwAAAHsAAAEhAAABIQAAAcIAAAEWAAAAUwAAAFkAAAAUc3RjbwAAAAAAAAAB
AAAAMAAAAGF1ZHRhAAAAWW1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAA
AAAALGlsc3QAAAAkqXRvbwAAABxkYXRhAAAAAQAAAABMYXZmNjAuMy4xMDA=
">
  Your browser does not support the video tag.
</video>
</div>
</div>
<p>There is some hesitation, but it looks like we are getting to the goal.</p>
</section>
</section>
</section>
<section id="summary" class="level1">
<h1>Summary</h1>
<p>In this blog, I introduced equinox, a library for handling neural networks with jax, and showed an example of a fast PPO implementation using equinox. Through writing this post, I found <code>eqx.filter_jit</code> very useful. Since I already get used to it, I feel a bit more frastration to write <code>@partial(jax.jit, static_argnums=(2, 3))</code> every time. However, if you want to use <code>jax.lax.scan</code> as an argument, you need to split it manually with <code>eqx.partition</code>, which was a bit troublesome.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>